---
# File: playbooks/deploy_wazuh_server.yml
# M√¥ t·∫£: Playbook tri·ªÉn khai Wazuh Server (Manager + Indexer + Dashboard)

- name: Deploy Wazuh Server
  hosts: wazuh_server
  become: yes
  gather_facts: yes

  vars:
    wazuh_mode: "server"
    wazuh_manager_ip: "{{ ansible_default_ipv4.address }}"
    wazuh_version: "4.7"
    wazuh_firewall_enabled: true

  pre_tasks:
    - name: "Pre-check: Hi·ªÉn th·ªã th√¥ng tin deployment"
      ansible.builtin.debug:
        msg: |
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë          üöÄ WAZUH SERVER DEPLOYMENT STARTING                   ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          üìã Deployment Information:
          ‚îú‚îÄ Target Host:    {{ inventory_hostname }}
          ‚îú‚îÄ IP Address:     {{ ansible_default_ipv4.address }}
          ‚îú‚îÄ OS:             {{ ansible_distribution }} {{ ansible_distribution_version }}
          ‚îú‚îÄ Mode:           SERVER
          ‚îî‚îÄ Wazuh Version:  {{ wazuh_version }}
          
          üì¶ Components to Install:
          ‚îú‚îÄ ‚úì Wazuh Manager
          ‚îú‚îÄ ‚úì Wazuh Indexer
          ‚îî‚îÄ ‚úì Wazuh Dashboard
          
          ‚è±Ô∏è  Estimated Time: 10-15 minutes
          
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    - name: "Pre-check: Ki·ªÉm tra k·∫øt n·ªëi internet"
      ansible.builtin.uri:
        url: https://packages.wazuh.com
        method: HEAD
        timeout: 10
      register: internet_check
      failed_when: false

    - name: "Pre-check: C·∫£nh b√°o n·∫øu kh√¥ng c√≥ k·∫øt n·ªëi internet"
      ansible.builtin.debug:
        msg: "‚ö†Ô∏è  WARNING: Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Wazuh repository. Ki·ªÉm tra k·∫øt n·ªëi internet!"
      when: internet_check.status is not defined or internet_check.status != 200

    - name: "Pre-check: Ki·ªÉm tra disk space"
      ansible.builtin.shell: df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
      register: disk_usage
      changed_when: false

    - name: "Pre-check: C·∫£nh b√°o n·∫øu disk space th·∫•p"
      ansible.builtin.debug:
        msg: "‚ö†Ô∏è  WARNING: Disk usage is {{ disk_usage.stdout }}%. Recommend at least 20GB free space."
      when: disk_usage.stdout | int > 80

    - name: "Pre-check: Ki·ªÉm tra RAM available"
      ansible.builtin.shell: free -m | grep Mem | awk '{print $2}'
      register: total_ram
      changed_when: false

    - name: "Pre-check: C·∫£nh b√°o n·∫øu RAM th·∫•p"
      ansible.builtin.debug:
        msg: "‚ö†Ô∏è  WARNING: Total RAM is {{ total_ram.stdout }}MB. Wazuh Server recommends at least 4GB RAM."
      when: total_ram.stdout | int < 4096

  roles:
    - role: wazuh

  post_tasks:
    - name: "Post-check: Verify Wazuh services"
      ansible.builtin.systemd:
        name: "{{ item }}"
      register: service_status
      loop:
        - wazuh-manager
        - wazuh-indexer
        - wazuh-dashboard
      failed_when: false

    - name: "Post-check: Hi·ªÉn th·ªã k·∫øt qu·∫£ deployment"
      ansible.builtin.debug:
        msg: |
          
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë       ‚úÖ WAZUH SERVER DEPLOYMENT COMPLETED SUCCESSFULLY        ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          üåê Access Information:
          ‚îú‚îÄ Dashboard URL:  https://{{ ansible_default_ipv4.address }}:443
          ‚îú‚îÄ API URL:        https://{{ ansible_default_ipv4.address }}:55000
          ‚îî‚îÄ Indexer URL:    https://{{ ansible_default_ipv4.address }}:9200
          
          üîê Default Credentials:
          ‚îú‚îÄ Username:   wazuh-wui
          ‚îî‚îÄ Password:   MyS3cr37P450r.*-
          
          ‚ö†Ô∏è  IMPORTANT SECURITY STEPS:
          1. Change default passwords immediately
          2. Configure SSL certificates for production
          3. Review firewall rules
          4. Set up backup procedures
          
          üìù Next Steps:
          1. Access the dashboard: https://{{ ansible_default_ipv4.address }}
          2. Deploy agents using: ansible-playbook playbooks/deploy_wazuh_agent.yml
          3. Review logs: sudo tail -f /var/ossec/logs/ossec.log
          
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  handlers:
    - name: Restart wazuh services
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - wazuh-manager
        - wazuh-indexer
        - wazuh-dashboard
