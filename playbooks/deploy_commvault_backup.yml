---
# Deploy Commvault Backup System for HA Infrastructure
# Phase 1: Setup Backup Server and Database Backup

- name: "Phase 1: Setup Commvault Backup Server"
  hosts: backup_server
  become: yes
  vars:
    commvault_install_commserve: yes
    commvault_install_mediaagent: yes
    commvault_server_ip: "{{ ansible_host }}"
    commvault_storage_path: "/backup/storage"

  tasks:
    - name: "Import Commvault role (Server)"
      ansible.builtin.import_role:
        name: commvault
      tags:
        - commvault-server

- name: "Phase 2: Deploy Backup Agents on Database Servers"
  hosts: web_servers
  become: yes
  vars:
    commvault_install_client: yes
    commvault_db_backup_enabled: yes
    use_native_backup: yes
    mysql_backup_databases:
      - wordpress
      - mysql

  pre_tasks:
    - name: "Gather Commvault Server IP"
      ansible.builtin.set_fact:
        commvault_server_ip: "{{ hostvars[groups['backup_server'][0]]['ansible_host'] }}"
      when: groups['backup_server'] is defined

  tasks:
    - name: "Import Commvault role (Client + Backup)"
      ansible.builtin.import_role:
        name: commvault
      tags:
        - commvault-client
        - database-backup

    - name: "Run initial backup test"
      ansible.builtin.command: /usr/local/bin/mariadb_backup.sh test
      register: initial_backup
      changed_when: false
      failed_when: false

    - name: "Display backup test results"
      ansible.builtin.debug:
        msg: |
          Initial backup test: {{ 'SUCCESS âœ“' if initial_backup.rc == 0 else 'FAILED âœ—' }}
          
          {% if initial_backup.rc == 0 %}
          You can now run full backup with:
          ansible {{ inventory_hostname }} -i inventory/hosts.yml -m shell -a "/usr/local/bin/mariadb_backup.sh full" -b
          {% endif %}

- name: "Phase 3: Deployment Summary and Next Steps"
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: "Display deployment summary"
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         COMMVAULT BACKUP SYSTEM DEPLOYMENT COMPLETE          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“¦ BACKUP INFRASTRUCTURE DEPLOYED:
          
          1ï¸âƒ£ BACKUP SERVER ({{ hostvars[groups['backup_server'][0]]['ansible_host'] if groups['backup_server'] is defined else '192.168.1.9' }})
             âœ… Commvault directories prepared
             âœ… Storage path ready: /backup/storage
             âœ… Firewall configured
             
          2ï¸âƒ£ DATABASE SERVERS (Web1 + Web2)
             âœ… Backup agents prepared
             âœ… MariaDB backup user created
             âœ… Native backup scripts deployed
             âœ… Automated daily backup scheduled (2:00 AM)
             
          ğŸ“Š BACKUP CONFIGURATION:
          
          Backup Method:
          â€¢ Primary: Commvault (requires commercial license)
          â€¢ Fallback: MariaBackup (open-source, ready to use)
          
          Backup Schedule:
          â€¢ Full backup: Daily at 2:00 AM
          â€¢ Retention: 7 days local, 30 days on Commvault Server
          â€¢ Compression: Enabled (pigz)
          
          Storage Locations:
          â€¢ Local: /backup/mysql/full/
          â€¢ Remote: {{ hostvars[groups['backup_server'][0]]['ansible_host'] if groups['backup_server'] is defined else '192.168.1.9' }}:/backup/storage
          
          ğŸ¯ NEXT STEPS FOR COMMVAULT:
          
          A. To use Commvault (commercial):
             1. Download Commvault from vendor
             2. Install on {{ hostvars[groups['backup_server'][0]]['ansible_host'] if groups['backup_server'] is defined else '192.168.1.9' }}
             3. Access: https://{{ hostvars[groups['backup_server'][0]]['ansible_host'] if groups['backup_server'] is defined else '192.168.1.9' }}:8403
             4. Configure MySQL subclients for Web1 + Web2
          
          B. To use Native Backup (ready now):
             1. Run manual backup:
                ansible web_servers -i inventory/hosts.yml -m shell -a "/usr/local/bin/mariadb_backup.sh full" -b
             
             2. View backups:
                ansible web_servers -i inventory/hosts.yml -m shell -a "ls -lh /backup/mysql/full/" -b
             
             3. Test restore (on one server):
                ansible Web1 -i inventory/hosts.yml -m shell -a "/usr/local/bin/mariadb_restore.sh /backup/mysql/full/backup_XXXXXX.xbstream.gz" -b
          
          ğŸ“‹ DEMO SCENARIOS:
          
          Demo 1: Database Backup
          â€¢ Create test data in WordPress
          â€¢ Run: /usr/local/bin/mariadb_backup.sh full
          â€¢ Verify backup files created
          
          Demo 2: Disaster Recovery
          â€¢ Simulate data loss
          â€¢ Restore from backup
          â€¢ Verify data integrity
          
          ğŸ“š DOCUMENTATION:
          â€¢ Backup role: roles/commvault/
          â€¢ Scripts: /usr/local/bin/mariadb_*.sh
          â€¢ Logs: /backup/mysql/logs/
          
          For Commvault documentation: roles/commvault/README.md
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
