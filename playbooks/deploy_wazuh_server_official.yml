---
# File: playbooks/deploy_wazuh_server_official.yml
# MÃ´ táº£: Deploy Wazuh Server sá»­ dá»¥ng Official Installation Script tá»« Wazuh
# PhÆ°Æ¡ng phÃ¡p: Download vÃ  cháº¡y wazuh-install.sh (production-ready)

- name: Deploy Wazuh Server using Official Script
  hosts: wazuh_server
  become: yes
  gather_facts: yes

  vars:
    wazuh_version: "4.7"
    wazuh_script_url: "https://packages.wazuh.com/{{ wazuh_version }}/wazuh-install.sh"
    wazuh_install_dir: "/tmp/wazuh-installation"
    wazuh_save_credentials: true

  tasks:
    - name: "ğŸ“Š Pre-check: Hiá»ƒn thá»‹ thÃ´ng tin deployment"
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘       ğŸš€ WAZUH SERVER OFFICIAL INSTALLATION                    â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“‹ Deployment Information:
          â”œâ”€ Target Host:    {{ ansible_hostname }}
          â”œâ”€ IP Address:     {{ ansible_default_ipv4.address }}
          â”œâ”€ OS:             {{ ansible_distribution }} {{ ansible_distribution_version }}
          â”œâ”€ Method:         Official Wazuh Installation Script
          â””â”€ Wazuh Version:  {{ wazuh_version }}
          
          ğŸ“¦ Components to Install:
          â”œâ”€ âœ“ Wazuh Indexer (OpenSearch)
          â”œâ”€ âœ“ Wazuh Manager
          â”œâ”€ âœ“ Filebeat
          â””â”€ âœ“ Wazuh Dashboard
          
          â±ï¸  Estimated Time: 10-15 minutes
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: "ğŸ” Pre-check: Kiá»ƒm tra RAM (minimum 4GB)"
      ansible.builtin.assert:
        that:
          - ansible_memtotal_mb >= 3800
        fail_msg: |
          âŒ ERROR: Insufficient RAM
          Required: 4GB (4096MB)
          Available: {{ ansible_memtotal_mb }}MB
          
          Wazuh Indexer requires at least 4GB RAM to run properly.
        success_msg: "âœ… RAM check passed: {{ ansible_memtotal_mb }}MB available"

    - name: "ğŸ” Pre-check: Kiá»ƒm tra Disk Space (minimum 20GB free)"
      ansible.builtin.shell: df -BG / | tail -1 | awk '{print $4}' | sed 's/G//'
      register: disk_free
      changed_when: false

    - name: "ğŸ” Pre-check: Cáº£nh bÃ¡o náº¿u disk space tháº¥p"
      ansible.builtin.debug:
        msg: |
          âš ï¸  WARNING: Low disk space
          Available: {{ disk_free.stdout }}GB
          Recommended: At least 20GB free
      when: disk_free.stdout | int < 20

    - name: "ğŸ” Pre-check: Kiá»ƒm tra cÃ¡c services Ä‘ang cháº¡y"
      ansible.builtin.shell: systemctl is-active {{ item }} 2>/dev/null || echo 'inactive'
      loop:
        - wazuh-manager
        - wazuh-indexer
        - wazuh-dashboard
      register: existing_services
      changed_when: false
      failed_when: false

    - name: "âš ï¸  Cáº£nh bÃ¡o: Wazuh Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t"
      ansible.builtin.debug:
        msg: |
          âš ï¸  WARNING: Wazuh services already exist
          
          Detected services:
          {% for service in existing_services.results %}
          - {{ service.item }}: {{ service.stdout }}
          {% endfor %}
          
          Recommendation:
          1. Backup current data if needed
          2. Run cleanup playbook:
             ansible-playbook -i inventory.ini playbooks/cleanup_wazuh_server.yml
          3. Then run this playbook again
          
          The script will fail if services are already installed.
      when: existing_services.results | selectattr('stdout', 'equalto', 'active') | list | length > 0

    - name: "ğŸ“¦ Install required dependencies"
      ansible.builtin.package:
        name:
          - curl
          - tar
          - gnupg
        state: present

    - name: "ğŸ“ Create installation directory"
      ansible.builtin.file:
        path: "{{ wazuh_install_dir }}"
        state: directory
        mode: '0755'

    - name: "â¬‡ï¸  Download Wazuh Official Installation Script"
      ansible.builtin.get_url:
        url: "{{ wazuh_script_url }}"
        dest: "{{ wazuh_install_dir }}/wazuh-install.sh"
        mode: '0755'
        timeout: 300
      register: script_download

    - name: "ğŸ“„ Verify script downloaded"
      ansible.builtin.stat:
        path: "{{ wazuh_install_dir }}/wazuh-install.sh"
      register: script_file

    - name: "âŒ Fail if script not downloaded"
      ansible.builtin.fail:
        msg: |
          Failed to download Wazuh installation script
          URL: {{ wazuh_script_url }}
          Check internet connection and URL validity.
      when: not script_file.stat.exists

    - name: "ğŸš€ Run Wazuh Installation Script (All-in-One)"
      ansible.builtin.shell: |
        cd {{ wazuh_install_dir }}
        bash wazuh-install.sh -a -i 2>&1 | tee wazuh-install.log
      args:
        creates: /var/ossec/bin/wazuh-control
      register: wazuh_install
      async: 1800  # 30 minutes timeout
      poll: 30     # Check every 30 seconds

    - name: "ğŸ’¾ Save installation output"
      ansible.builtin.copy:
        content: "{{ wazuh_install.stdout }}"
        dest: "{{ wazuh_install_dir }}/wazuh-install-output.txt"
        mode: '0600'
      when: wazuh_install.stdout is defined

    - name: "ğŸ” Find wazuh-install-files.tar location"
      ansible.builtin.find:
        paths: "{{ wazuh_install_dir }}"
        patterns: "wazuh-install-files.tar"
        recurse: no
      register: tar_file_search

    - name: "ğŸ“¦ Extract wazuh-install-files.tar if exists"
      ansible.builtin.unarchive:
        src: "{{ tar_file_search.files[0].path }}"
        dest: "{{ wazuh_install_dir }}"
        remote_src: yes
      when: tar_file_search.matched > 0

    - name: "ğŸ”‘ Extract credentials from wazuh-passwords.txt"
      ansible.builtin.shell: |
        if [ -f "{{ wazuh_install_dir }}/wazuh-install-files/wazuh-passwords.txt" ]; then
          cat {{ wazuh_install_dir }}/wazuh-install-files/wazuh-passwords.txt
        elif [ -f "{{ wazuh_install_dir }}/wazuh-passwords.txt" ]; then
          cat {{ wazuh_install_dir }}/wazuh-passwords.txt
        else
          grep -i "password\|user\|admin" {{ wazuh_install_dir }}/wazuh-install.log | head -20
        fi
      register: credentials_raw
      changed_when: false
      failed_when: false

    - name: "ğŸ” Parse admin username"
      ansible.builtin.shell: |
        echo "{{ credentials_raw.stdout }}" | grep -i "admin" | grep -oP "(?<=User: )'[^']+'" | tr -d "'" || echo "admin"
      register: admin_username
      changed_when: false
      failed_when: false

    - name: "ğŸ” Parse admin password"
      ansible.builtin.shell: |
        echo "{{ credentials_raw.stdout }}" | grep -i "admin" | grep -oP "(?<=Password: )'[^']+'" | tr -d "'" || \
        echo "{{ credentials_raw.stdout }}" | grep -A1 "'admin'" | tail -1 | awk '{print $2}' | tr -d "'"
      register: admin_password
      changed_when: false
      failed_when: false

    - name: "ğŸ“ Set credentials facts"
      ansible.builtin.set_fact:
        wazuh_admin_user: "{{ admin_username.stdout | trim | default('admin', true) }}"
        wazuh_admin_pass: "{{ admin_password.stdout | trim | default('CHECK_LOG_FILE', true) }}"

    - name: "â³ Wait for services to stabilize (60 seconds)"
      ansible.builtin.pause:
        seconds: 60

    - name: "âœ… Verify Wazuh Manager service"
      ansible.builtin.systemd:
        name: wazuh-manager
      register: manager_status

    - name: "âœ… Verify Wazuh Indexer service"
      ansible.builtin.systemd:
        name: wazuh-indexer
      register: indexer_status

    - name: "âœ… Verify Wazuh Dashboard service"
      ansible.builtin.systemd:
        name: wazuh-dashboard
      register: dashboard_status

    - name: "âœ… Verify Filebeat service"
      ansible.builtin.systemd:
        name: filebeat
      register: filebeat_status

    - name: "ğŸ”¥ Configure firewall ports"
      ansible.posix.firewalld:
        port: "{{ item }}"
        permanent: yes
        state: enabled
        immediate: yes
      loop:
        - 1514/udp   # Agent communication
        - 1515/tcp   # Agent enrollment
        - 55000/tcp  # Wazuh API
        - 443/tcp    # Dashboard HTTPS
        - 9200/tcp   # Indexer (optional, for debugging)
      when: 
        - ansible_os_family == "RedHat"
        - ansible_facts.services['firewalld.service'] is defined
        - ansible_facts.services['firewalld.service'].state == 'running'
      failed_when: false

    - name: "ğŸŒ Get Wazuh Dashboard URL"
      ansible.builtin.set_fact:
        dashboard_url: "https://{{ ansible_default_ipv4.address }}"

    - name: "ğŸ” Test Dashboard accessibility"
      ansible.builtin.uri:
        url: "{{ dashboard_url }}"
        method: GET
        validate_certs: no
        status_code: [200, 401, 302]
        timeout: 30
      register: dashboard_test
      failed_when: false
      retries: 5
      delay: 10

    - name: "ğŸ” Test Wazuh API"
      ansible.builtin.uri:
        url: "https://{{ ansible_default_ipv4.address }}:55000"
        method: GET
        validate_certs: no
        status_code: [200, 401]
        timeout: 10
      register: api_test
      failed_when: false

    - name: "ğŸ“Š Display Installation Summary"
      ansible.builtin.debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         âœ… WAZUH SERVER INSTALLATION COMPLETED                 â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š Service Status:
          â”œâ”€ Wazuh Manager:   {{ 'âœ… Running' if manager_status.status.ActiveState == 'active' else 'âŒ Stopped' }}
          â”œâ”€ Wazuh Indexer:   {{ 'âœ… Running' if indexer_status.status.ActiveState == 'active' else 'âŒ Stopped' }}
          â”œâ”€ Wazuh Dashboard: {{ 'âœ… Running' if dashboard_status.status.ActiveState == 'active' else 'âŒ Stopped' }}
          â””â”€ Filebeat:        {{ 'âœ… Running' if filebeat_status.status.ActiveState == 'active' else 'âŒ Stopped' }}
          
          ğŸŒ Access Information:
          â”œâ”€ Dashboard URL:  {{ dashboard_url }}
          â”œâ”€ API Endpoint:   https://{{ ansible_default_ipv4.address }}:55000
          â””â”€ Manager IP:     {{ ansible_default_ipv4.address }}
          
          ğŸ” LOGIN CREDENTIALS:
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Username: {{ wazuh_admin_user }}                                â”‚
          â”‚ Password: {{ wazuh_admin_pass }}                                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          {% if wazuh_admin_pass == 'CHECK_LOG_FILE' %}
          âš ï¸  Password parsing failed. View manually:
          sudo cat {{ wazuh_install_dir }}/wazuh-install-files/wazuh-passwords.txt
          {% endif %}
          
          ğŸ“ Installation Files:
          â”œâ”€ Passwords File: {{ wazuh_install_dir }}/wazuh-install-files/wazuh-passwords.txt
          â”œâ”€ Installation Log: {{ wazuh_install_dir }}/wazuh-install.log
          â””â”€ Installation Output: {{ wazuh_install_dir }}/wazuh-install-output.txt
          
          âš ï¸  IMPORTANT NEXT STEPS:
          1. âš ï¸  SAVE YOUR PASSWORD NOW! (Copy from above)
          2. ğŸŒ Login to Dashboard: {{ dashboard_url }}
          3. ğŸ”‘ Change default password immediately:
             sudo /usr/share/wazuh-indexer/plugins/opensearch-security/tools/wazuh-passwords-tool.sh -u admin -p NewPassword
          4. ğŸ¤– Deploy agents:
             ansible-playbook -i inventory.ini playbooks/deploy_wazuh_agent.yml
          
          ğŸ”§ Useful Commands:
          # View all credentials:
          sudo cat {{ wazuh_install_dir }}/wazuh-install-files/wazuh-passwords.txt
          
          # Or from tar file:
          sudo tar -xOf {{ wazuh_install_dir }}/wazuh-install-files.tar wazuh-install-files/wazuh-passwords.txt
          
          # Check services:
          sudo systemctl status wazuh-manager wazuh-indexer wazuh-dashboard
          
          # View logs:
          sudo tail -f /var/ossec/logs/ossec.log
          
          # List agents:
          sudo /var/ossec/bin/agent_control -l
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: "ğŸ’¾ Save credentials to local file"
      ansible.builtin.copy:
        content: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              WAZUH SERVER CREDENTIALS                          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Generated: {{ ansible_date_time.iso8601 }}
          Server IP: {{ ansible_default_ipv4.address }}
          Dashboard: {{ dashboard_url }}
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     LOGIN CREDENTIALS                          â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚ Username: {{ wazuh_admin_user }}                               â”‚
          â”‚ Password: {{ wazuh_admin_pass }}                               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          âš ï¸  SECURITY WARNING:
          1. This file contains sensitive credentials
          2. Change the password immediately after first login
          3. Delete this file after saving credentials securely
          
          ğŸ“ HOW TO LOGIN:
          1. Open browser: {{ dashboard_url }}
          2. Username: {{ wazuh_admin_user }}
          3. Password: {{ wazuh_admin_pass }}
          4. Click "Log in"
          
          ğŸ”„ HOW TO CHANGE PASSWORD:
          sudo /usr/share/wazuh-indexer/plugins/opensearch-security/tools/wazuh-passwords-tool.sh -u admin -p YourNewPassword
          
          ğŸ“ ALL CREDENTIALS FILE:
          {{ wazuh_install_dir }}/wazuh-install-files/wazuh-passwords.txt
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          FULL CREDENTIALS (All Users):
          {{ credentials_raw.stdout }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        dest: "{{ wazuh_install_dir }}/WAZUH_CREDENTIALS.txt"
        mode: '0600'
      when: wazuh_save_credentials | bool

    - name: "ğŸ“¥ Fetch credentials to Ansible control node"
      ansible.builtin.fetch:
        src: "{{ wazuh_install_dir }}/WAZUH_CREDENTIALS.txt"
        dest: "./wazuh-credentials-{{ ansible_hostname }}.txt"
        flat: yes
      when: wazuh_save_credentials | bool

    - name: "âœ… Installation Complete - Summary"
      ansible.builtin.debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘       ğŸ‰ WAZUH SERVER INSTALLATION COMPLETED!                  â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“‹ QUICK ACCESS:
          â”œâ”€ Dashboard: {{ dashboard_url }}
          â”œâ”€ Username:  {{ wazuh_admin_user }}
          â””â”€ Password:  {{ wazuh_admin_pass }}
          
          ğŸ“„ Credentials saved to:
          â”œâ”€ Local:  ./wazuh-credentials-{{ ansible_hostname }}.txt
          â””â”€ Remote: {{ wazuh_install_dir }}/WAZUH_CREDENTIALS.txt
          
          ğŸš€ NEXT STEPS:
          1. ğŸŒ Login: {{ dashboard_url }}
          2. ğŸ”‘ Change password (REQUIRED!)
          3. ğŸ¤– Deploy agents: 
             ansible-playbook -i inventory.ini playbooks/deploy_wazuh_agent.yml
          
          ğŸ“š Documentation:
          - Official Docs: https://documentation.wazuh.com/
          - Agent Deployment: See playbooks/deploy_wazuh_agent.yml
          
          âš ï¸  SECURITY CHECKLIST:
          â˜ Change default admin password
          â˜ Review firewall rules
          â˜ Enable 2FA (recommended)
          â˜ Delete credentials file after saving: ./wazuh-credentials-*.txt
          â˜ Setup backup procedures
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
