---
# File: playbooks/deploy_wazuh_agent.yml
# MÃ´ táº£: Playbook triá»ƒn khai Wazuh Agent trÃªn nhiá»u há»‡ Ä‘iá»u hÃ nh

- name: Deploy Wazuh Agent on Multiple OS
  hosts: wazuh_agents
  gather_facts: yes

  vars:
    wazuh_mode: "agent"
    wazuh_manager_ip: "192.168.1.125"  # IP cá»§a Wazuh Manager
    wazuh_agent_group: "default"
    wazuh_version: "4.7"

  pre_tasks:
    - name: "Pre-check: Hiá»ƒn thá»‹ thÃ´ng tin deployment"
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          ğŸš€ WAZUH AGENT DEPLOYMENT STARTING                    â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“‹ Agent Information:
          â”œâ”€ Target Host:    {{ inventory_hostname }}
          â”œâ”€ OS Family:      {{ ansible_os_family }}
          â”œâ”€ OS:             {{ ansible_distribution | default('Unknown') }} {{ ansible_distribution_version | default('') }}
          â”œâ”€ Mode:           AGENT
          â”œâ”€ Agent Name:     {{ ansible_hostname }}
          â””â”€ Agent Group:    {{ wazuh_agent_group }}
          
          ğŸ”— Manager Connection:
          â”œâ”€ Manager IP:     {{ wazuh_manager_ip }}
          â””â”€ Manager Port:   1514/udp
          
          â±ï¸  Estimated Time: 5-10 minutes
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: "Pre-check: Kiá»ƒm tra káº¿t ná»‘i Ä‘áº¿n Wazuh Manager"
      ansible.builtin.wait_for:
        host: "{{ wazuh_manager_ip }}"
        port: 1514
        timeout: 10
      register: manager_check
      failed_when: false
      when: ansible_os_family != "Windows"

    - name: "Pre-check: Cáº£nh bÃ¡o náº¿u khÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c Manager"
      ansible.builtin.debug:
        msg: |
          âš ï¸  WARNING: KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n Wazuh Manager {{ wazuh_manager_ip }}:1514
          Vui lÃ²ng kiá»ƒm tra:
          - Manager cÃ³ Ä‘ang cháº¡y khÃ´ng?
          - Firewall cÃ³ má»Ÿ port 1514/udp khÃ´ng?
          - Network cÃ³ káº¿t ná»‘i Ä‘Æ°á»£c khÃ´ng?
      when: 
        - ansible_os_family != "Windows"
        - manager_check.failed is defined
        - manager_check.failed

  roles:
    - role: wazuh

  post_tasks:
    - name: "Post-check: Verify Agent service (Linux)"
      ansible.builtin.systemd:
        name: wazuh-agent
      register: agent_status_linux
      failed_when: false
      when: ansible_os_family in ["Debian", "RedHat", "Suse"]

    - name: "Post-check: Verify Agent service (Windows)"
      ansible.windows.win_service:
        name: WazuhSvc
      register: agent_status_windows
      failed_when: false
      when: ansible_os_family == "Windows"

    - name: "Post-check: Verify Agent service (macOS)"
      ansible.builtin.command: "{{ wazuh_macos_install_path | default('/Library/Ossec') }}/bin/wazuh-control status"
      register: agent_status_macos
      failed_when: false
      changed_when: false
      when: ansible_os_family == "Darwin"

    - name: "Post-check: Hiá»ƒn thá»‹ káº¿t quáº£ deployment (Linux)"
      ansible.builtin.debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘       âœ… WAZUH AGENT DEPLOYMENT COMPLETED SUCCESSFULLY         â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ–¥ï¸  Agent Information:
          â”œâ”€ Host:           {{ inventory_hostname }}
          â”œâ”€ OS:             {{ ansible_distribution }} {{ ansible_distribution_version }}
          â”œâ”€ Agent Name:     {{ ansible_hostname }}
          â””â”€ Agent Group:    {{ wazuh_agent_group }}
          
          ğŸ”— Connection:
          â”œâ”€ Manager IP:     {{ wazuh_manager_ip }}
          â””â”€ Status:         {{ 'Connected' if agent_status_linux.status.ActiveState == 'active' else 'Not Running' }}
          
          ğŸ“ Verify Commands:
          â”œâ”€ Status:         sudo systemctl status wazuh-agent
          â”œâ”€ Logs:           sudo tail -f /var/ossec/logs/ossec.log
          â””â”€ Agent Info:     sudo /var/ossec/bin/agent-control -l
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: ansible_os_family in ["Debian", "RedHat", "Suse"]

    - name: "Post-check: Hiá»ƒn thá»‹ káº¿t quáº£ deployment (Windows)"
      ansible.builtin.debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘       âœ… WAZUH AGENT DEPLOYMENT COMPLETED SUCCESSFULLY         â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ–¥ï¸  Agent Information:
          â”œâ”€ Host:           {{ inventory_hostname }}
          â”œâ”€ OS:             Windows {{ ansible_distribution_version }}
          â”œâ”€ Agent Name:     {{ ansible_hostname }}
          â””â”€ Agent Group:    {{ wazuh_agent_group }}
          
          ğŸ”— Connection:
          â”œâ”€ Manager IP:     {{ wazuh_manager_ip }}
          â””â”€ Status:         {{ 'Connected' if agent_status_windows.state == 'running' else 'Not Running' }}
          
          ğŸ“ Verify Commands (PowerShell):
          â”œâ”€ Status:         Get-Service WazuhSvc
          â”œâ”€ Logs:           Get-Content "C:\Program Files (x86)\ossec-agent\ossec.log" -Tail 50
          â””â”€ Config:         Get-Content "C:\Program Files (x86)\ossec-agent\ossec.conf"
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: ansible_os_family == "Windows"

    - name: "Post-check: Hiá»ƒn thá»‹ káº¿t quáº£ deployment (macOS)"
      ansible.builtin.debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘       âœ… WAZUH AGENT DEPLOYMENT COMPLETED SUCCESSFULLY         â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ–¥ï¸  Agent Information:
          â”œâ”€ Host:           {{ inventory_hostname }}
          â”œâ”€ OS:             macOS {{ ansible_distribution_version | default('Unknown') }}
          â”œâ”€ Agent Name:     {{ ansible_hostname }}
          â””â”€ Agent Group:    {{ wazuh_agent_group }}
          
          ğŸ”— Connection:
          â”œâ”€ Manager IP:     {{ wazuh_manager_ip }}
          â””â”€ Status:         {{ 'Connected' if 'running' in agent_status_macos.stdout else 'Not Running' }}
          
          ğŸ“ Verify Commands:
          â”œâ”€ Status:         sudo /Library/Ossec/bin/wazuh-control status
          â”œâ”€ Logs:           sudo tail -f /Library/Ossec/logs/ossec.log
          â””â”€ Agent Info:     sudo /Library/Ossec/bin/agent-control -l
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: ansible_os_family == "Darwin"
