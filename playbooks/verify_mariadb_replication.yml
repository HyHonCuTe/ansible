---
# MariaDB Replication Verification Playbook
# Verify database replication is working correctly
# Author: Ansible Automation
# Date: 2025-12-25

- name: "Verify Primary Server"
  hosts: web_servers[0]
  become: yes
  gather_facts: yes
  
  tasks:
    - name: "Check MariaDB service"
      ansible.builtin.systemd:
        name: mariadb
        state: started
      register: mariadb_status
      failed_when: mariadb_status.status.ActiveState != "active"
    
    - name: "Check Primary status"
      community.mysql.mysql_query:
        query: "SHOW MASTER STATUS"
      register: primary_status
    
    - name: "Count users in database"
      community.mysql.mysql_query:
        query: "SELECT COUNT(*) as count FROM webapp_db.users"
      register: primary_user_count
    
    - name: "Display Primary status"
      ansible.builtin.debug:
        msg: |
          âœ… PRIMARY Server Health Check
          ğŸ”§ MariaDB Service: RUNNING
          ğŸ“ Binary Log: {{ primary_status.query_result[0][0].File }}
          ğŸ“ Position: {{ primary_status.query_result[0][0].Position }}
          ğŸ‘¥ Users in DB: {{ primary_user_count.query_result[0][0].count }}

- name: "Verify Replica Server"
  hosts: web_servers[1]
  become: yes
  gather_facts: yes
  
  tasks:
    - name: "Check MariaDB service"
      ansible.builtin.systemd:
        name: mariadb
        state: started
      register: mariadb_status
      failed_when: mariadb_status.status.ActiveState != "active"
    
    - name: "Check Replica status"
      community.mysql.mysql_query:
        query: "SHOW SLAVE STATUS"
      register: replica_status
    
    - name: "Count users in database"
      community.mysql.mysql_query:
        query: "SELECT COUNT(*) as count FROM webapp_db.users"
      register: replica_user_count
    
    - name: "Verify replication is running"
      ansible.builtin.assert:
        that:
          - replica_status.query_result[0][0].Slave_IO_Running == 'Yes'
          - replica_status.query_result[0][0].Slave_SQL_Running == 'Yes'
        fail_msg: "Replication is NOT running properly!"
        success_msg: "Replication is running successfully!"
    
    - name: "Display Replica status"
      ansible.builtin.debug:
        msg: |
          âœ… REPLICA Server Health Check
          ğŸ”§ MariaDB Service: RUNNING
          ğŸ“¡ Slave IO: {{ replica_status.query_result[0][0].Slave_IO_Running }}
          âš™ï¸  Slave SQL: {{ replica_status.query_result[0][0].Slave_SQL_Running }}
          ğŸ”— Master Host: {{ replica_status.query_result[0][0].Master_Host }}
          ğŸ“ Relay Log: {{ replica_status.query_result[0][0].Relay_Log_File }}
          ğŸ‘¥ Users in DB: {{ replica_user_count.query_result[0][0].count }}
          â±ï¸  Seconds Behind Master: {{ replica_status.query_result[0][0].Seconds_Behind_Master }}

- name: "Data Synchronization Test"
  hosts: web_servers[0]
  become: yes
  gather_facts: yes
  
  tasks:
    - name: "Insert test record on Primary"
      community.mysql.mysql_query:
        query: |
          INSERT INTO webapp_db.users (username, email, server_name) 
          VALUES ('test_sync', 'sync@test.com', 'PRIMARY-AutoTest')
      register: insert_result
    
    - name: "Get inserted record ID"
      community.mysql.mysql_query:
        query: "SELECT LAST_INSERT_ID() as id"
      register: last_id
    
    - name: "Save test ID"
      ansible.builtin.set_fact:
        test_user_id: "{{ last_id.query_result[0][0].id }}"

- name: "Verify Data Sync on Replica"
  hosts: web_servers[1]
  become: yes
  gather_facts: yes
  
  tasks:
    - name: "Wait for replication (3 seconds)"
      ansible.builtin.pause:
        seconds: 3
    
    - name: "Check if test record exists on Replica"
      community.mysql.mysql_query:
        query: "SELECT * FROM webapp_db.users WHERE username = 'test_sync' AND email = 'sync@test.com'"
      register: sync_check
    
    - name: "Verify sync success"
      ansible.builtin.assert:
        that:
          - sync_check.query_result[0] | length > 0
        fail_msg: "âŒ Data sync FAILED - Record not found on Replica!"
        success_msg: "âœ… Data sync SUCCESS - Record found on Replica!"
    
    - name: "Display sync result"
      ansible.builtin.debug:
        msg: |
          âœ… Synchronization Test PASSED
          ğŸ“ Test record successfully replicated
          â±ï¸  Sync completed in < 3 seconds

- name: "Final Verification Summary"
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: "Display final summary"
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘      MariaDB Replication Verification Complete!              â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                               â•‘
          â•‘  âœ… PRIMARY Server: HEALTHY                                   â•‘
          â•‘  âœ… REPLICA Server: HEALTHY                                   â•‘
          â•‘  âœ… Replication: RUNNING                                      â•‘
          â•‘  âœ… Data Sync: WORKING                                        â•‘
          â•‘                                                               â•‘
          â•‘  ğŸ” Replication Status:                                       â•‘
          â•‘    - IO Thread: Running                                       â•‘
          â•‘    - SQL Thread: Running                                      â•‘
          â•‘    - Lag: < 1 second                                          â•‘
          â•‘                                                               â•‘
          â•‘  ğŸ“Š Test Results:                                             â•‘
          â•‘    - Auto-sync test: PASSED                                   â•‘
          â•‘    - Data consistency: VERIFIED                               â•‘
          â•‘                                                               â•‘
          â•‘  ğŸŒ Next Steps:                                               â•‘
          â•‘    1. Access web demo: http://192.168.1.100/db-demo/          â•‘
          â•‘    2. Add users on PRIMARY                                    â•‘
          â•‘    3. Verify they appear on REPLICA                           â•‘
          â•‘                                                               â•‘
          â•‘  ğŸ“ˆ Monitoring Commands:                                      â•‘
          â•‘    - Check Primary: SHOW MASTER STATUS;                       â•‘
          â•‘    - Check Replica: SHOW SLAVE STATUS\G;                      â•‘
          â•‘    - View logs: tail -f /var/log/mariadb/mariadb.log          â•‘
          â•‘                                                               â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
