---
- name: "Deploy Suricata IDS on Security Server"
  hosts: security_servers
  become: yes
  gather_facts: yes
  
  pre_tasks:
    - name: "Display deployment information"
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          Suricata IDS Deployment Starting                    â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Target: {{ ansible_hostname }}                              
          â•‘  IP: {{ ansible_host }}                                      
          â•‘  Interface: {{ suricata_interface }}                         
          â•‘  Network: {{ suricata_home_net }}                            
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  roles:
    - role: suricata
      tags:
        - suricata
        - ids

  post_tasks:
    - name: "Wait for Suricata to fully start"
      ansible.builtin.pause:
        seconds: 10

    - name: "Verify Suricata is running"
      ansible.builtin.systemd:
        name: suricata
      register: suricata_service

    - name: "Check if rules are loaded"
      ansible.builtin.shell: "grep 'rule reload complete' {{ suricata_log_dir }}/suricata.log | tail -1"
      register: rules_loaded
      changed_when: false
      failed_when: false

    - name: "Check interface is in promiscuous mode"
      ansible.builtin.shell: "ip link show {{ suricata_interface }} | grep PROMISC"
      register: promisc_mode
      changed_when: false
      failed_when: false

    - name: "Get Suricata stats"
      ansible.builtin.shell: "suricatasc -c 'dump-counters' | head -20"
      register: suricata_stats
      changed_when: false
      failed_when: false

    - name: "Display deployment summary"
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        Suricata IDS Deployment Complete!                     â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                               â•‘
          â•‘  âœ… Service Status: {{ suricata_service.status.ActiveState }}
          â•‘  âœ… Interface: {{ suricata_interface }}                      
          â•‘  âœ… Promiscuous Mode: {{ 'ENABLED âœ“' if promisc_mode.rc == 0 else 'DISABLED âœ—' }}
          â•‘  âœ… Rules Loaded: {{ 'YES âœ“' if rules_loaded.rc == 0 else 'CHECKING...' }}
          â•‘                                                               â•‘
          â•‘  ğŸŒ Web Dashboard:                                            â•‘
          â•‘     http://{{ ansible_host }}:{{ suricata_web_ui_port }}/
          â•‘                                                               â•‘
          â•‘  ğŸ“Š Monitoring:                                               â•‘
          â•‘     - HAProxy: 192.168.1.8, 192.168.1.25                     â•‘
          â•‘     - Web Servers: 192.168.1.27, 192.168.1.30                â•‘
          â•‘     - VIP: 192.168.1.100                                     â•‘
          â•‘                                                               â•‘
          â•‘  ğŸ“ Log Files:                                                â•‘
          â•‘     - EVE JSON: {{ suricata_log_dir }}/eve.json              
          â•‘     - Fast Log: {{ suricata_log_dir }}/fast.log              
          â•‘     - Main Log: {{ suricata_log_dir }}/suricata.log          
          â•‘                                                               â•‘
          â•‘  ğŸ¯ Demo Tests Available:                                     â•‘
          â•‘     1. Port Scan Detection                                   â•‘
          â•‘     2. SQL Injection Detection                               â•‘
          â•‘     3. Suspicious User-Agent Detection                       â•‘
          â•‘     4. Directory Traversal Detection                         â•‘
          â•‘                                                               â•‘
          â•‘  ğŸ“ˆ Next Steps:                                               â•‘
          â•‘     - Access web dashboard to view alerts                    â•‘
          â•‘     - Run test scenarios                                     â•‘
          â•‘     - Monitor HA infrastructure traffic                      â•‘
          â•‘                                                               â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
