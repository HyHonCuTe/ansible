#!/bin/bash
# MariaDB Restore Script

set -e

BACKUP_FILE="$1"
RESTORE_DIR="/tmp/mariadb_restore_$$"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR:${NC} $1" >&2
    exit 1
}

warn() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING:${NC} $1"
}

if [ -z "$BACKUP_FILE" ]; then
    error "Usage: $0 <backup_file>"
fi

if [ ! -f "$BACKUP_FILE" ]; then
    error "Backup file not found: $BACKUP_FILE"
fi

warn "This will restore database from backup!"
warn "Current data will be REPLACED!"
read -p "Continue? (yes/no): " -r
if [[ ! $REPLY =~ ^yes$ ]]; then
    log "Restore cancelled"
    exit 0
fi

log "Starting restore from: $BACKUP_FILE"

# Create restore directory
mkdir -p "$RESTORE_DIR"

# Extract backup
log "Extracting backup..."
if [[ "$BACKUP_FILE" == *.gz ]]; then
    pigz -dc "$BACKUP_FILE" | mbstream -x -C "$RESTORE_DIR"
else
    mbstream -x -C "$RESTORE_DIR" < "$BACKUP_FILE"
fi

# Prepare backup
log "Preparing backup..."
mariabackup --prepare --target-dir="$RESTORE_DIR"

# Stop MariaDB
log "Stopping MariaDB..."
systemctl stop mariadb

# Backup current data (safety)
SAFETY_BACKUP="/var/lib/mysql.before_restore.$(date +%s)"
log "Creating safety backup: $SAFETY_BACKUP"
mv /var/lib/mysql "$SAFETY_BACKUP"

# Restore
log "Restoring data..."
mariabackup --copy-back --target-dir="$RESTORE_DIR"

# Fix permissions
log "Fixing permissions..."
chown -R mysql:mysql /var/lib/mysql

# Start MariaDB
log "Starting MariaDB..."
systemctl start mariadb

# Cleanup
log "Cleaning up..."
rm -rf "$RESTORE_DIR"

log "Restore completed successfully!"
log "Safety backup saved at: $SAFETY_BACKUP"
log "You can remove it after verification: rm -rf $SAFETY_BACKUP"
