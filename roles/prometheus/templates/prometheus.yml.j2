# Prometheus Configuration
# Generated by Ansible - {{ ansible_date_time.iso8601 }}
# Author: hyhoncute

global:
  scrape_interval: {{ prometheus_scrape_interval }}
  evaluation_interval: {{ prometheus_evaluation_interval }}
  external_labels:
    monitor: '{{ ansible_hostname }}'
    environment: 'production'

# Alertmanager configuration
{% if install_alertmanager %}
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'localhost:9093'
{% endif %}

# Load rules
rule_files:
  - "{{ prometheus_config_dir }}/rules/*.yml"

# Scrape configurations
scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          instance: 'prometheus-server'

  # Node Exporter - Local
  - job_name: 'node_exporter'
    static_configs:
      - targets: ['localhost:9100']
        labels:
          instance: 'prometheus-server'
          host: '{{ ansible_hostname }}'

{% if groups['monitored_hosts'] is defined and groups['monitored_hosts'] | length > 0 %}
  # Node Exporter - Remote Hosts
  - job_name: 'node_exporter_remote'
    static_configs:
      - targets:
{% for host in groups['monitored_hosts'] %}
          - '{{ hostvars[host].ansible_host }}:9100'
{% endfor %}
        labels:
          job: 'node_exporter_remote'
{% endif %}

{% if prometheus_targets is defined %}
{% for target in prometheus_targets %}
{% if target.job_name not in ['prometheus', 'node_exporter'] %}
  - job_name: '{{ target.job_name }}'
{% if target.scrape_interval is defined %}
    scrape_interval: {{ target.scrape_interval }}
{% endif %}
    static_configs:
{% for config in target.static_configs %}
      - targets:
{% for t in config.targets %}
          - '{{ t }}'
{% endfor %}
{% if config.labels is defined %}
        labels:
{% for key, value in config.labels.items() %}
          {{ key }}: '{{ value }}'
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}