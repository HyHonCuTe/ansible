---
# File: roles/scap_check/tasks/linux.yml

- name: "CÃ i Ä‘áº·t gÃ³i OpenSCAP"
  ansible.builtin.package:
    name:
      - openscap-scanner
      - scap-security-guide
    state: present

- name: "Táº¡o thÆ° má»¥c lÆ°u káº¿t quáº£ kiá»ƒm tra trÃªn mÃ¡y Ä‘Ã­ch (Linux)"
  ansible.builtin.file:
    path: /var/tmp/scap
    state: directory
    mode: '0755'
  when: ansible_os_family != "Windows"

- name: "TÃ¬m file datastream SCAP cá»§a AlmaLinux"
  ansible.builtin.find:
    paths: /usr/share/xml/scap/ssg/content/
    patterns: "ssg-almalinux*-ds.xml"
  register: scap_files
  when: ansible_os_family != "Windows"

- name: "Dá»«ng playbook náº¿u khÃ´ng tÃ¬m tháº¥y file SCAP"
  ansible.builtin.fail:
    msg: "KhÃ´ng tÃ¬m tháº¥y file SCAP cá»§a AlmaLinux trong /usr/share/xml/scap/ssg/content/"
  when:
    - ansible_os_family != "Windows"
    - scap_files.matched | int == 0

- name: "Hiá»ƒn thá»‹ profile Ä‘ang sá»­ dá»¥ng"
  ansible.builtin.debug:
    msg: |
      ğŸ” Scanning vá»›i profile: {{ cis_profile }}
      ğŸ“„ SCAP file: {{ scap_files.files[0].path }}
      ğŸ–¥ï¸  Host: {{ inventory_hostname }} ({{ ansible_default_ipv4.address | default('N/A') }})
  when: ansible_os_family != "Windows"

# ==================== SCAN TRÆ¯á»šC KHI FIX ====================
- name: "Cháº¡y kiá»ƒm tra CIS Benchmark vá»›i OpenSCAP (TRÆ¯á»šC FIX)"
  ansible.builtin.command: >
    oscap xccdf eval
    --fetch-remote-resources
    --profile {{ cis_profile }}
    --results /var/tmp/scap/scan_before.xml
    --report /var/tmp/scap/scan_before.html
    {{ scap_files.files[0].path }}
  register: ket_qua_before
  changed_when: false
  failed_when: ket_qua_before.rc not in [0, 2]
  when: ansible_os_family != "Windows"

- name: "Äáº¿m sá»‘ lá»—i FAIL (trÆ°á»›c fix)"
  ansible.builtin.shell: |
    sed -n 's/.*<result>\([^<]*\)<\/result>.*/\1/p' /var/tmp/scap/scan_before.xml | grep -c "^fail$" || echo "0"
  register: failed_before
  changed_when: false
  when: ansible_os_family != "Windows"

- name: "Äáº¿m sá»‘ PASS (trÆ°á»›c fix)"
  ansible.builtin.shell: |
    sed -n 's/.*<result>\([^<]*\)<\/result>.*/\1/p' /var/tmp/scap/scan_before.xml | grep -c "^pass$" || echo "0"
  register: passed_before
  changed_when: false
  when: ansible_os_family != "Windows"

- name: "Hiá»ƒn thá»‹ káº¿t quáº£ scan TRÆ¯á»šC FIX"
  ansible.builtin.debug:
    msg: |
      ğŸ“Š ===== Káº¾T QUáº¢ SCAN TRÆ¯á»šC FIX =====
      ğŸ–¥ï¸  Host: {{ inventory_hostname }} ({{ ansible_default_ipv4.address | default('N/A') }})
      âœ… PASS:   {{ passed_before.stdout }}
      âŒ FAIL:   {{ failed_before.stdout }}
      ğŸ“ˆ Total:  {{ (passed_before.stdout | int) + (failed_before.stdout | int) }}
      
      {% if failed_before.stdout | int > 0 %}
      âš ï¸  PhÃ¡t hiá»‡n {{ failed_before.stdout }} lá»—i cáº§n kháº¯c phá»¥c!
      {% else %}
      âœ… Há»‡ thá»‘ng Ä‘áº¡t chuáº©n báº£o máº­t
      {% endif %}
  when: ansible_os_family != "Windows"

# ==================== Táº O THá»¦ Má»¤C TRÃŠN CONTROLLER ====================
- name: "Táº¡o thÆ° má»¥c results trÃªn Ansible Controller"
  delegate_to: localhost
  run_once: false
  ansible.builtin.file:
    path: "{{ playbook_dir }}/../roles/scap_check/results"
    state: directory
    mode: '0775'

- name: "Táº¡o thÆ° má»¥c backup trÃªn Ansible Controller"
  delegate_to: localhost
  run_once: false
  ansible.builtin.file:
    path: "{{ playbook_dir }}/../roles/scap_check/backup"
    state: directory
    mode: '0775'

# ==================== COPY REPORT TRÆ¯á»šC FIX ====================
- name: "Copy bÃ¡o cÃ¡o TRÆ¯á»šC FIX vá» Ansible Controller"
  ansible.builtin.fetch:
    src: /var/tmp/scap/scan_before.html
    dest: "{{ playbook_dir }}/../roles/scap_check/results/{{ inventory_hostname }}_{{ ansible_default_ipv4.address | default('unknown') }}_BEFORE_{{ lookup('pipe','date +%Y%m%d-%H%M%S') }}.html"
    flat: yes
  when: ansible_os_family != "Windows"

# ==================== BACKUP ====================
- name: "Táº¡o backup trÃªn remote host"
  ansible.builtin.shell: |
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="/var/tmp/backup_${TIMESTAMP}.tar.gz"
    tar -czf "$BACKUP_FILE" \
      /etc/ssh/ \
      /etc/pam.d/ \
      /etc/security/ \
      /etc/login.defs \
      /etc/sudoers \
      /etc/sudoers.d/ \
      /etc/sysctl.conf \
      /etc/sysctl.d/ \
      /etc/fstab \
      /etc/audit/ \
      /etc/rsyslog.conf \
      /etc/default/grub \
      /boot/grub2/grubenv \
      2>/dev/null || true
    
    echo "$BACKUP_FILE"
  register: backup_file_path
  become: true
  when:
    - ansible_os_family != "Windows"
    - auto_remediate | default(false) | bool

- name: "Copy backup vá» Ansible Controller"
  ansible.builtin.fetch:
    src: "{{ backup_file_path.stdout }}"
    dest: "{{ playbook_dir }}/../roles/scap_check/backup/{{ inventory_hostname }}_{{ ansible_default_ipv4.address | default('unknown') }}_backup_{{ lookup('pipe','date +%Y%m%d-%H%M%S') }}.tar.gz"
    flat: yes
  when:
    - ansible_os_family != "Windows"
    - auto_remediate | default(false) | bool
    - backup_file_path.stdout is defined
    - backup_file_path.stdout | length > 0

- name: "Hiá»ƒn thá»‹ thÃ´ng tin backup"
  ansible.builtin.debug:
    msg: |
      ğŸ’¾ ===== BACKUP INFO =====
      Remote backup: {{ backup_file_path.stdout }}
      Local backup:  {{ playbook_dir }}/../roles/scap_check/backup/{{ inventory_hostname }}_{{ ansible_default_ipv4.address | default('unknown') }}_backup_*.tar.gz
      
      ğŸ”™ Äá»ƒ restore (trÃªn remote host):
      sudo tar -xzf {{ backup_file_path.stdout }} -C /
      sudo systemctl restart sshd
  when:
    - ansible_os_family != "Windows"
    - auto_remediate | default(false) | bool
    - backup_file_path is defined

# ==================== REMEDIATION ====================
- name: "Cháº¡y auto-remediation vá»›i oscap"
  ansible.builtin.command: >
    oscap xccdf eval
    --remediate
    --fetch-remote-resources
    --profile {{ cis_profile }}
    --results /var/tmp/scap/scan_after.xml
    --report /var/tmp/scap/scan_after.html
    {{ scap_files.files[0].path }}
  register: ket_qua_remediate
  changed_when: true
  failed_when: ket_qua_remediate.rc not in [0, 2]
  become: true
  when:
    - ansible_os_family != "Windows"
    - auto_remediate | default(false) | bool
  ignore_errors: yes

# ==================== SCAN SAU KHI FIX ====================
- name: "Äáº¿m sá»‘ lá»—i FAIL (sau fix)"
  ansible.builtin.shell: |
    sed -n 's/.*<result>\([^<]*\)<\/result>.*/\1/p' /var/tmp/scap/scan_after.xml | grep -c "^fail$" || echo "0"
  register: failed_after
  changed_when: false
  when:
    - ansible_os_family != "Windows"
    - auto_remediate | default(false) | bool

- name: "Äáº¿m sá»‘ PASS (sau fix)"
  ansible.builtin.shell: |
    sed -n 's/.*<result>\([^<]*\)<\/result>.*/\1/p' /var/tmp/scap/scan_after.xml | grep -c "^pass$" || echo "0"
  register: passed_after
  changed_when: false
  when:
    - ansible_os_family != "Windows"
    - auto_remediate | default(false) | bool

# ==================== COPY REPORT SAU FIX ====================
- name: "Copy bÃ¡o cÃ¡o SAU FIX vá» Ansible Controller"
  ansible.builtin.fetch:
    src: /var/tmp/scap/scan_after.html
    dest: "{{ playbook_dir }}/../roles/scap_check/results/{{ inventory_hostname }}_{{ ansible_default_ipv4.address | default('unknown') }}_AFTER_{{ lookup('pipe','date +%Y%m%d-%H%M%S') }}.html"
    flat: yes
  when:
    - ansible_os_family != "Windows"
    - auto_remediate | default(false) | bool

# ==================== THá»NG KÃŠ SO SÃNH ====================
- name: "TÃ­nh toÃ¡n sá»‘ lá»—i Ä‘Ã£ fix"
  ansible.builtin.set_fact:
    errors_fixed: "{{ (failed_before.stdout | int) - (failed_after.stdout | default(failed_before.stdout) | int) }}"
    fix_percentage: "{{ (((failed_before.stdout | int) - (failed_after.stdout | default(failed_before.stdout) | int)) / (failed_before.stdout | int) * 100) | round(1) if (failed_before.stdout | int) > 0 else 0 }}"
  when:
    - ansible_os_family != "Windows"
    - auto_remediate | default(false) | bool

- name: "ğŸ“Š Hiá»ƒn thá»‹ thá»‘ng kÃª SO SÃNH TRÆ¯á»šC/SAU"
  ansible.builtin.debug:
    msg: |
      
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘           ğŸ“Š THá»NG KÃŠ Káº¾T QUáº¢ OPENSCAN & REMEDIATION          â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ğŸ–¥ï¸  Host Information:
      â”œâ”€ Hostname:     {{ inventory_hostname }}
      â”œâ”€ IP Address:   {{ ansible_default_ipv4.address | default('N/A') }}
      â””â”€ OS:           {{ ansible_distribution }} {{ ansible_distribution_version }}
      
      ğŸ“‹ Profile: {{ cis_profile }}
      
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                    TRÆ¯á»šC FIX vs SAU FIX                         â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ Metric          â”‚ TRÆ¯á»šC        â”‚ SAU          â”‚ THAY Äá»”I        â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ âœ… PASSED       â”‚ {{ '%12s' | format(passed_before.stdout) }} â”‚ {{ '%12s' | format(passed_after.stdout | default('N/A')) }} â”‚ {{ '%15s' | format('+' + ((passed_after.stdout | default('0') | int) - (passed_before.stdout | int)) | string if auto_remediate | default(false) else 'N/A') }} â”‚
      â”‚ âŒ FAILED       â”‚ {{ '%12s' | format(failed_before.stdout) }} â”‚ {{ '%12s' | format(failed_after.stdout | default('N/A')) }} â”‚ {{ '%15s' | format('-' + errors_fixed | string if auto_remediate | default(false) else 'N/A') }} â”‚
      â”‚ ğŸ“ˆ TOTAL        â”‚ {{ '%12s' | format((passed_before.stdout | int) + (failed_before.stdout | int)) }} â”‚ {{ '%12s' | format((passed_after.stdout | default('0') | int) + (failed_after.stdout | default('0') | int)) }} â”‚                 â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      
      {% if auto_remediate | default(false) %}
      ğŸ¯ Remediation Results:
      â”œâ”€ Errors Fixed:     {{ errors_fixed }} / {{ failed_before.stdout }}
      â”œâ”€ Fix Success Rate: {{ fix_percentage }}%
      â””â”€ Status:           {% if fix_percentage | float > 70 %}âœ… EXCELLENT{% elif fix_percentage | float > 50 %}âš ï¸  GOOD{% elif fix_percentage | float > 0 %}âš ï¸  NEEDS REVIEW{% else %}âŒ FAILED{% endif %}
      
      {% endif %}
      ğŸ“‚ Files Saved:
      â”œâ”€ Before Report:  roles/scap_check/results/{{ inventory_hostname }}_{{ ansible_default_ipv4.address | default('unknown') }}_BEFORE_*.html
      {% if auto_remediate | default(false) %}
      â”œâ”€ After Report:   roles/scap_check/results/{{ inventory_hostname }}_{{ ansible_default_ipv4.address | default('unknown') }}_AFTER_*.html
      â””â”€ Backup:         roles/scap_check/backup/{{ inventory_hostname }}_{{ ansible_default_ipv4.address | default('unknown') }}_backup_*.tar.gz
      {% else %}
      â””â”€ (Auto-remediate not enabled)
      {% endif %}
      
      {% if not auto_remediate | default(false) %}
      ğŸ’¡ Äá»ƒ cháº¡y auto-fix:
      ansible-playbook playbooks/scap_check.yml -e "auto_remediate=true"
      {% endif %}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  when: ansible_os_family != "Windows"

# ==================== Cáº¢NH BÃO Náº¾U CÃ“ Váº¤N Äá»€ ====================
- name: "âš ï¸  Cáº¢NH BÃO: TÃ¬nh tráº¡ng xáº¥u Ä‘i sau remediation"
  ansible.builtin.debug:
    msg: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘                    âš ï¸  WARNING âš ï¸                          â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      Sá»‘ lá»—i TÄ‚NG sau khi remediation!
      TrÆ°á»›c: {{ failed_before.stdout }} lá»—i
      Sau:   {{ failed_after.stdout }} lá»—i
      
      ğŸ”™ NÃŠN RESTORE BACKUP NGAY:
      
      1. TrÃªn remote host:
         sudo tar -xzf {{ backup_file_path.stdout | default('/var/tmp/backup_*.tar.gz') }} -C /
         sudo systemctl restart sshd
         sudo reboot
      
      2. Hoáº·c tá»« controller:
         scp roles/scap_check/backup/{{ inventory_hostname }}_*_backup_*.tar.gz {{ ansible_user }}@{{ ansible_default_ipv4.address }}:/tmp/
         ssh {{ ansible_user }}@{{ ansible_default_ipv4.address }} 'sudo tar -xzf /tmp/backup_*.tar.gz -C / && sudo reboot'
  when:
    - ansible_os_family != "Windows"
    - auto_remediate | default(false) | bool
    - failed_after.stdout | int > failed_before.stdout | int

# ==================== Táº O FILE SUMMARY ====================
- name: "Táº¡o file summary report"
  delegate_to: localhost
  ansible.builtin.copy:
    content: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    SCAP COMPLIANCE SUMMARY REPORT
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      Host Information:
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      Hostname:          {{ inventory_hostname }}
      IP Address:        {{ ansible_default_ipv4.address | default('N/A') }}
      Operating System:  {{ ansible_distribution }} {{ ansible_distribution_version }}
      Scan Date:         {{ lookup('pipe', 'date "+%Y-%m-%d %H:%M:%S"') }}
      Profile:           {{ cis_profile }}
      
      Scan Results BEFORE Remediation:
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      âœ… PASSED:         {{ passed_before.stdout }}
      âŒ FAILED:         {{ failed_before.stdout }}
      ğŸ“ˆ TOTAL CHECKS:   {{ (passed_before.stdout | int) + (failed_before.stdout | int) }}
      
      {% if auto_remediate | default(false) %}
      Scan Results AFTER Remediation:
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      âœ… PASSED:         {{ passed_after.stdout }}
      âŒ FAILED:         {{ failed_after.stdout }}
      ğŸ“ˆ TOTAL CHECKS:   {{ (passed_after.stdout | int) + (failed_after.stdout | int) }}
      
      Remediation Summary:
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      Errors Fixed:      {{ errors_fixed }} out of {{ failed_before.stdout }}
      Success Rate:      {{ fix_percentage }}%
      Status:            {% if fix_percentage | float > 70 %}âœ… EXCELLENT{% elif fix_percentage | float > 50 %}âš ï¸  GOOD{% elif fix_percentage | float > 0 %}âš ï¸  NEEDS REVIEW{% else %}âŒ FAILED{% endif %}
      
      {% endif %}
      Files Generated:
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      Before Report:     {{ inventory_hostname }}_{{ ansible_default_ipv4.address | default('unknown') }}_BEFORE_*.html
      {% if auto_remediate | default(false) %}
      After Report:      {{ inventory_hostname }}_{{ ansible_default_ipv4.address | default('unknown') }}_AFTER_*.html
      Backup File:       {{ inventory_hostname }}_{{ ansible_default_ipv4.address | default('unknown') }}_backup_*.tar.gz
      {% endif %}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    dest: "{{ playbook_dir }}/../roles/scap_check/results/{{ inventory_hostname }}_{{ ansible_default_ipv4.address | default('unknown') }}_SUMMARY_{{ lookup('pipe','date +%Y%m%d-%H%M%S') }}.txt"
    mode: '0644'
  when: ansible_os_family != "Windows"