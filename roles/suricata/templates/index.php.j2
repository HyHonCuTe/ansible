<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suricata IDS - Alert Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1>üõ°Ô∏è Suricata IDS - Security Monitoring Dashboard</h1>
                <div class="server-info">
                    <span class="badge badge-primary">Server: {{ ansible_hostname }}</span>
                    <span class="badge badge-info">IP: {{ ansible_host }}</span>
                    <span class="badge badge-success" id="status">‚óè ACTIVE</span>
                </div>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üö®</div>
                <div class="stat-content">
                    <h3 id="total-alerts">0</h3>
                    <p>Total Alerts</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-content">
                    <h3 id="high-severity">0</h3>
                    <p>High Severity</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <h3 id="medium-severity">0</h3>
                    <p>Medium Severity</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ÑπÔ∏è</div>
                <div class="stat-content">
                    <h3 id="low-severity">0</h3>
                    <p>Low Severity</p>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <button class="btn btn-primary" onclick="refreshAlerts()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="clearFilters()">Clear Filters</button>
            <div class="auto-refresh">
                <label>
                    <input type="checkbox" id="auto-refresh" checked> Auto-refresh (5s)
                </label>
            </div>
        </div>

        <div class="filters">
            <input type="text" id="filter-ip" placeholder="Filter by IP..." class="filter-input">
            <select id="filter-severity" class="filter-select">
                <option value="">All Severities</option>
                <option value="1">High</option>
                <option value="2">Medium</option>
                <option value="3">Low</option>
            </select>
            <input type="text" id="filter-signature" placeholder="Filter by signature..." class="filter-input">
        </div>

        <div class="alerts-container">
            <h2>Recent Alerts</h2>
            <div id="alerts-table">
                <div class="loading">Loading alerts...</div>
            </div>
        </div>

        <div class="system-info">
            <div class="info-section">
                <h3>üìã System Information</h3>
                <ul>
                    <li><strong>Interface:</strong> {{ suricata_interface }}</li>
                    <li><strong>Network:</strong> {{ suricata_home_net }}</li>
                    <li><strong>Log Path:</strong> {{ suricata_log_dir }}/eve.json</li>
                    <li><strong>Rules:</strong> Emerging Threats + Custom</li>
                </ul>
            </div>
            
            <div class="info-section">
                <h3>üéØ Demo Instructions</h3>
                <ul>
                    <li><strong>Port Scan:</strong> <code>nmap -sS 192.168.1.27</code></li>
                    <li><strong>SQL Injection:</strong> <code>?id=1' OR '1'='1</code></li>
                    <li><strong>User-Agent:</strong> <code>curl -A "sqlmap" http://192.168.1.100</code></li>
                    <li><strong>Path Traversal:</strong> <code>/../../etc/passwd</code></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;

        function refreshAlerts() {
            fetch('api.php?action=get_alerts&limit=500')
                .then(response => response.json())
                .then(data => {
                    updateStats(data.stats);
                    displayAlerts(data.alerts);
                })
                .catch(error => {
                    console.error('Error fetching alerts:', error);
                    document.getElementById('alerts-table').innerHTML = 
                        '<div class="error">Failed to load alerts. Check if Suricata is running.</div>';
                });
        }

        function updateStats(stats) {
            document.getElementById('total-alerts').textContent = stats.total || 0;
            document.getElementById('high-severity').textContent = stats.high || 0;
            document.getElementById('medium-severity').textContent = stats.medium || 0;
            document.getElementById('low-severity').textContent = stats.low || 0;
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alerts-table');
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="no-alerts">No alerts found. System is secure! ‚úÖ</div>';
                return;
            }

            let html = '<div class="table-scroll"><table class="alerts-table"><thead><tr>';
            html += '<th>Time</th><th>Severity</th><th>Signature</th>';
            html += '<th>Source</th><th>Destination</th><th>Protocol</th></tr></thead><tbody>';

            alerts.forEach(alert => {
                const severity = getSeverityBadge(alert.severity);
                const time = new Date(alert.timestamp).toLocaleString('vi-VN');
                
                html += `<tr class="alert-row severity-${alert.severity}">`;
                html += `<td>${time}</td>`;
                html += `<td>${severity}</td>`;
                html += `<td><strong>${alert.signature}</strong></td>`;
                html += `<td>${alert.src_ip}:${alert.src_port}</td>`;
                html += `<td>${alert.dest_ip}:${alert.dest_port}</td>`;
                html += `<td>${alert.proto}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function getSeverityBadge(severity) {
            const badges = {
                '1': '<span class="badge badge-danger">HIGH</span>',
                '2': '<span class="badge badge-warning">MEDIUM</span>',
                '3': '<span class="badge badge-info">LOW</span>'
            };
            return badges[severity] || '<span class="badge badge-secondary">UNKNOWN</span>';
        }

        function clearFilters() {
            document.getElementById('filter-ip').value = '';
            document.getElementById('filter-severity').value = '';
            document.getElementById('filter-signature').value = '';
            refreshAlerts();
        }

        // Auto-refresh toggle
        document.getElementById('auto-refresh').addEventListener('change', function() {
            if (this.checked) {
                autoRefreshInterval = setInterval(refreshAlerts, 5000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        });

        // Initial load
        refreshAlerts();
        autoRefreshInterval = setInterval(refreshAlerts, 5000);
    </script>
</body>
</html>
