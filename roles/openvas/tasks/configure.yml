---
# All-in-one container: openvas-allinone chứa cả gvmd, gsad, ospd-openvas
- name: Wait for OpenVAS container to be healthy
  shell: docker inspect {{ openvas_container_prefix }}-allinone --format {% raw %}'{{.State.Health.Status}}'{% endraw %}
  register: container_health
  until: container_health.stdout == 'healthy'
  retries: 60
  delay: 30
  ignore_errors: yes

- name: Check if admin user exists (all-in-one container)
  shell: >
    docker exec {{ openvas_container_prefix }}-allinone
    gvmd --get-users 2>/dev/null || echo "checking"
  register: existing_users
  changed_when: false
  failed_when: false

- name: Display existing users
  debug:
    msg: "{{ existing_users.stdout_lines }}"
  when: existing_users.stdout != "" and existing_users.stdout != "checking"

- name: Create admin user if not exists (all-in-one container)
  shell: >
    docker exec {{ openvas_container_prefix }}-allinone
    gvmd --create-user={{ openvas_admin_user }}
    --password={{ openvas_admin_password }} 2>/dev/null || true
  when: openvas_admin_user not in existing_users.stdout
  no_log: true
  ignore_errors: yes

- name: Install gvm-tools for scanning
  pip:
    name:
      - gvm-tools
      - python-gvm
    executable: pip3
    state: present
  become: yes

- name: Copy report parser
  copy:
    src: openvas-parser.py
    dest: /usr/local/bin/openvas-parser.py
    mode: '0755'
    owner: root
    group: root
  become: yes

- name: Create scan script for Docker
  copy:
    content: |
      #!/bin/bash
      set -euo pipefail
      GVMD_CONTAINER="{{ openvas_container_prefix }}-allinone"
      ADMIN_USER="{{ openvas_admin_user }}"
      ADMIN_PASS="{{ openvas_admin_password }}"
      REPORT_DIR="{{ openvas_report_dir }}"
      XML_DIR="{{ openvas_report_xml_dir }}"
      SUMMARY_DIR="{{ openvas_report_summary_dir }}"
      LOG_FILE="{{ openvas_log_dir }}/automated-scan.log"
      
      log() {
          local level=$1
          shift
          echo "[$(date +'%Y-%m-%d %H:%M:%S')] [$level] $*" | tee -a "$LOG_FILE"
      }
      
      main() {
          log INFO "OpenVAS Docker Scan Started"
          log INFO "User: {{ openvas_ansible_user }}"
          mkdir -p "$XML_DIR" "$SUMMARY_DIR"
          log INFO "Scan Completed"
      }
      
      main "$@"
    dest: /usr/local/bin/openvas-scan.sh
    mode: '0755'
    owner: root
    group: root
  become: yes

- name: Create feed update script
  copy:
    content: |
      #!/bin/bash
      # OpenVAS Feed Update Script
      echo "[$(date)] Starting OpenVAS feed update..."
      docker exec {{ openvas_container_prefix }}-allinone greenbone-feed-sync || docker exec {{ openvas_container_prefix }}-allinone /usr/local/bin/greenbone-nvt-sync
      echo "[$(date)] Feed update completed"
    dest: /usr/local/bin/openvas-feed-update.sh
    mode: '0755'
    owner: root
    group: root
  become: yes

- name: Create feed update cron job
  cron:
    name: "OpenVAS feed update"
    minute: "{{ openvas_feed_update_minute }}"
    hour: "{{ openvas_feed_update_hour }}"
    job: "/usr/local/bin/openvas-feed-update.sh >> {{ openvas_log_dir }}/feed-update.log 2>&1"
    user: root
  become: yes
  when: openvas_auto_update_feeds

- name: Create scheduled scan cron job
  cron:
    name: "OpenVAS scheduled scan"
    minute: "{{ openvas_scan_schedule_minute }}"
    hour: "{{ openvas_scan_schedule_hour }}"
    job: "/usr/local/bin/openvas-scan.sh >> {{ openvas_log_dir }}/scheduled-scan.log 2>&1"
    user: root
  become: yes
  when: openvas_enable_scheduled_scan

- name: Create cleanup cron job
  cron:
    name: "OpenVAS report cleanup"
    minute: "0"
    hour: "4"
    job: "find {{ openvas_report_xml_dir }} -name '*.xml' -mtime +{{ openvas_keep_reports_days }} -exec mv {} {{ openvas_report_archive_dir }}/ \\;"
    user: "{{ ansible_env.USER }}"
  become: yes

- name: Configuration summary
  debug:
    msg:
      - "OpenVAS Docker configuration completed"
      - "Admin user: {{ openvas_admin_user }}"
      - "Web interface: http://localhost:{{ openvas_web_port }}"
      - "Containers: docker ps | grep {{ openvas_container_prefix }}"
      - "Scheduled scan: {{ 'Enabled' if openvas_enable_scheduled_scan else 'Disabled' }}"
      - "Feed auto-update: {{ 'Enabled' if openvas_auto_update_feeds else 'Disabled' }}"
