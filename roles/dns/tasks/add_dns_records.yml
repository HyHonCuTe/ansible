# - name: Thêm A records vào zone thuận
#   ansible.windows.win_dns_record:
#     zone: "{{ dns_zone_name }}"
#     name: "{{ item.name }}"
#     type: "{{ item.type }}"
#     value: "{{ item.value }}"
#     state: present
#   loop: "{{ dns_records }}"
#   loop_control:
#     label: "{{ item.name }} ({{ item.type }})"
#   when: 
#     - item.type == "A"

# - name: Thêm MX records
#   ansible.windows.win_shell: |
#     Add-DnsServerResourceRecord `
#       -MX `
#       -ZoneName "{{ dns_zone_name }}" `
#       -Name "@" `
#       -MailExchange "{{ item.value }}" `
#       -Preference {{ item.priority }}  
#   loop: "{{ dns_records }}"
#   loop_control:
#     label: "MX Record for {{ item.value }}"
#   when: 
#     - item.type == "MX"
#   ignore_errors: yes

#     # Thêm PTR records
# - name: Thêm bản ghi PTR vào zone ngược
#   ansible.windows.win_dns_record:
#     zone: "{{ dns_reverse_zone }}"
#     name: "{{ item.value.split('.')[-1] }}"
#     type: "PTR"
#     value: "{{ item.name }}.{{ dns_zone_name }}."
#     state: present
#   loop: "{{ dns_records }}"
#   loop_control:
#     label: "PTR for {{ item.value }}"
#   when: 
#     - item.type == "A"

# - name: Thêm bản ghi A cho domain gốc vodaohuyhoang.com
#   win_dns_record:
#     zone: "vodaohuyhoang.com"
#     name: "@"
#     type: "A"
#     value: "192.168.198.100"
#     state: present


 # Thêm bản ghi A và các bản ghi khác (trừ MX)
    - name: Thêm A records vào zone thuận
      ansible.windows.win_dns_record:
        zone: "{{ dns_zone_name }}"
        name: "{{ item.name }}"
        type: "{{ item.type }}"
        value: "{{ item.value }}"
        state: present
      loop: "{{ dns_records }}"
      loop_control:
        label: "{{ item.name }} ({{ item.type }})"
      when: 
        - item.type != "MX"

    # Thêm MX Record bằng PowerShell (do module win_dns_record không hỗ trợ)
    # - name: Thêm MX records
    #   ansible.windows.win_shell: |
    #     Add-DnsServerResourceRecord -MX `
    #       -ZoneName "{{ dns_zone_name }}" `
    #       -Name "@" `
    #       -MailExchange "mail.vodaohuyhoang.com." `
    #       -Preference 10
    #   when: 
    #     - "'@' in dns_records | map(attribute='name') | list"

    # Thêm bản ghi PTR cho Reverse Zone (chỉ 1 task)
    - name: Thêm bản ghi Reverse (PTR)
      ansible.windows.win_dns_record:
        zone: "{{ dns_reverse_zone }}"
        name: "{{ item.ip.split('.')[-1] }}"  # Ví dụ: 250 từ IP 192.168.193.250
        type: "PTR"
        value: "{{ item.name }}"
      loop: "{{ reverse_records }}"

    # Thêm NS Record cho cả Forward và Reverse Zone
    - name: Thêm NS Record cho Forward Zone
      ansible.windows.win_dns_record:
        zone: "{{ dns_zone_name }}"
        name: "@"
        type: "NS"
        value: "ns1.vodaohuyhoang.com."

    - name: Thêm NS Record cho Reverse Zone
      ansible.windows.win_dns_record:
        zone: "{{ dns_reverse_zone }}"
        name: "@"
        type: "NS"
        value: "ns1.vodaohuyhoang.com."

    # Thêm A Record cho DNS Server (bắt buộc)
    - name: Thêm A Record cho DNS Server
      ansible.windows.win_dns_record:
        zone: "{{ dns_zone_name }}"
        name: "ns1"
        type: "A"
        value: "192.168.193.250"