---
# File: roles/wazuh/tasks/install_agent_macos.yml
# MÃ´ táº£: CÃ i Ä‘áº·t Wazuh Agent trÃªn macOS

# ==================== PREREQUISITES ====================
- name: "Kiá»ƒm tra macOS version"
  ansible.builtin.command: sw_vers -productVersion
  register: macos_version
  changed_when: false

- name: "Hiá»ƒn thá»‹ macOS version"
  ansible.builtin.debug:
    msg: "macOS Version: {{ macos_version.stdout }}"

# ==================== DOWNLOAD WAZUH AGENT ====================
- name: "Táº¡o thÆ° má»¥c táº¡m Ä‘á»ƒ download Wazuh Agent"
  ansible.builtin.file:
    path: /tmp/wazuh
    state: directory
    mode: '0755'

- name: "Kiá»ƒm tra xem Wazuh Agent Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t chÆ°a"
  ansible.builtin.stat:
    path: "{{ wazuh_macos_install_path }}"
  register: wazuh_installed

- name: "Download Wazuh Agent PKG for macOS"
  ansible.builtin.get_url:
    url: "{{ wazuh_macos_agent_url }}"
    dest: /tmp/wazuh/wazuh-agent.pkg
    mode: '0644'
  when: not wazuh_installed.stat.exists

# ==================== INSTALL WAZUH AGENT ====================
- name: "CÃ i Ä‘áº·t Wazuh Agent trÃªn macOS"
  ansible.builtin.command: >
    installer -pkg /tmp/wazuh/wazuh-agent.pkg
    -target /
  become: yes
  register: install_result
  changed_when: install_result.rc == 0
  when: not wazuh_installed.stat.exists

# ==================== CONFIGURE WAZUH AGENT ====================
- name: "Deploy Wazuh Agent configuration"
  ansible.builtin.template:
    src: wazuh_agent_macos_ossec.conf.j2
    dest: "{{ wazuh_agent_config_path_macos }}"
    owner: root
    group: wheel
    mode: '0640'
  become: yes

- name: "Cáº¥u hÃ¬nh Wazuh Manager IP"
  ansible.builtin.lineinfile:
    path: "{{ wazuh_agent_config_path_macos }}"
    regexp: '<address>.*</address>'
    line: "    <address>{{ wazuh_manager_ip }}</address>"
    state: present
  become: yes

# ==================== START WAZUH AGENT ====================
- name: "Load Wazuh Agent LaunchDaemon"
  ansible.builtin.command: launchctl load /Library/LaunchDaemons/com.wazuh.agent.plist
  become: yes
  changed_when: false
  failed_when: false

- name: "Start Wazuh Agent service"
  ansible.builtin.command: "{{ wazuh_macos_install_path }}/bin/wazuh-control start"
  become: yes
  register: start_result
  changed_when: "'Starting' in start_result.stdout"

# ==================== VERIFY INSTALLATION ====================
- name: "Chá» Wazuh Agent káº¿t ná»‘i vá»›i Manager"
  ansible.builtin.wait_for:
    timeout: 30
  delegate_to: localhost
  connection: local
  become: false

- name: "Kiá»ƒm tra tráº¡ng thÃ¡i Wazuh Agent"
  ansible.builtin.command: "{{ wazuh_macos_install_path }}/bin/wazuh-control status"
  register: agent_status
  changed_when: false
  become: yes

- name: "Láº¥y thÃ´ng tin Agent keys"
  ansible.builtin.command: cat {{ wazuh_macos_install_path }}/etc/client.keys
  register: agent_keys
  changed_when: false
  failed_when: false
  become: yes

- name: "Hiá»ƒn thá»‹ thÃ´ng tin Wazuh Agent trÃªn macOS"
  ansible.builtin.debug:
    msg: |
      
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘         âœ… WAZUH AGENT (macOS) INSTALLATION COMPLETED          â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ğŸ–¥ï¸  Host:           {{ inventory_hostname }}
      ğŸ OS:             macOS {{ macos_version.stdout }}
      ğŸ“¦ Agent Name:     {{ wazuh_agent_name }}
      ğŸ‘¥ Agent Group:    {{ wazuh_agent_group }}
      
      ğŸ”— Connection:
      â”œâ”€ Manager IP:     {{ wazuh_manager_ip }}
      â”œâ”€ Manager Port:   {{ wazuh_manager_port }}
      â””â”€ Protocol:       {{ wazuh_manager_protocol | upper }}
      
      âœ… Service Status:  {{ 'Running' if 'running' in agent_status.stdout else 'Stopped' }}
      
      ğŸ“‹ Verify Commands:
      â”œâ”€ Status:         sudo {{ wazuh_macos_install_path }}/bin/wazuh-control status
      â”œâ”€ Logs:           sudo tail -f {{ wazuh_macos_install_path }}/logs/ossec.log
      â”œâ”€ Agent Info:     sudo {{ wazuh_macos_install_path }}/bin/agent-control -l
      â””â”€ Config:         sudo cat {{ wazuh_agent_config_path_macos }}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ==================== CLEANUP ====================
- name: "XÃ³a file PKG táº¡m"
  ansible.builtin.file:
    path: /tmp/wazuh
    state: absent
