---
# File: roles/wazuh/tasks/install_agent_linux.yml
# MÃ´ táº£: CÃ i Ä‘áº·t Wazuh Agent trÃªn Linux (Ubuntu, Debian, CentOS, RHEL, Rocky, AlmaLinux)

# ==================== PREREQUISITES ====================
- name: "CÃ i Ä‘áº·t cÃ¡c gÃ³i phá»¥ thuá»™c (Debian/Ubuntu)"
  ansible.builtin.apt:
    name:
      - gnupg
      - apt-transport-https
      - curl
      - lsb-release
    state: present
    update_cache: yes
  become: yes
  when: ansible_os_family == "Debian"

- name: "CÃ i Ä‘áº·t cÃ¡c gÃ³i phá»¥ thuá»™c (RedHat/CentOS)"
  ansible.builtin.yum:
    name:
      - curl
      - gnupg
      - yum-utils
    state: present
  become: yes
  when: ansible_os_family == "RedHat"

# ==================== ADD WAZUH REPOSITORY ====================
- name: "ThÃªm Wazuh GPG key (Debian/Ubuntu)"
  ansible.builtin.apt_key:
    url: "{{ wazuh_repo_gpg_key }}"
    state: present
  become: yes
  when: ansible_os_family == "Debian"

- name: "ThÃªm Wazuh repository (Debian/Ubuntu)"
  ansible.builtin.apt_repository:
    repo: "{{ wazuh_repo_apt }}"
    state: present
    filename: wazuh
  become: yes
  when: ansible_os_family == "Debian"

- name: "ThÃªm Wazuh GPG key (RedHat/CentOS)"
  ansible.builtin.rpm_key:
    key: "{{ wazuh_repo_gpg_key }}"
    state: present
  become: yes
  when: ansible_os_family == "RedHat"

- name: "ThÃªm Wazuh repository (RedHat/CentOS)"
  ansible.builtin.yum_repository:
    name: wazuh
    description: Wazuh repository
    baseurl: "{{ wazuh_repo_yum }}"
    gpgcheck: yes
    gpgkey: "{{ wazuh_repo_gpg_key }}"
    enabled: yes
  become: yes
  when: ansible_os_family == "RedHat"

# ==================== INSTALL WAZUH AGENT ====================
- name: "CÃ i Ä‘áº·t Wazuh Agent (Debian/Ubuntu)"
  ansible.builtin.apt:
    name: wazuh-agent
    state: present
    update_cache: yes
  become: yes
  when: ansible_os_family == "Debian"
  environment:
    WAZUH_MANAGER: "{{ wazuh_manager_ip }}"
    WAZUH_AGENT_GROUP: "{{ wazuh_agent_group }}"
    WAZUH_AGENT_NAME: "{{ wazuh_agent_name }}"

- name: "CÃ i Ä‘áº·t Wazuh Agent (RedHat/CentOS)"
  ansible.builtin.yum:
    name: wazuh-agent
    state: present
  become: yes
  when: ansible_os_family == "RedHat"
  environment:
    WAZUH_MANAGER: "{{ wazuh_manager_ip }}"
    WAZUH_AGENT_GROUP: "{{ wazuh_agent_group }}"
    WAZUH_AGENT_NAME: "{{ wazuh_agent_name }}"

# ==================== CONFIGURE WAZUH AGENT ====================
- name: "Deploy Wazuh Agent configuration"
  ansible.builtin.template:
    src: wazuh_agent_linux_ossec.conf.j2
    dest: "{{ wazuh_agent_config_path_linux }}"
    owner: root
    group: wazuh
    mode: '0640'
  become: yes
  notify: Restart wazuh-agent

# ==================== CONFIGURE SELINUX (RHEL/CENTOS) ====================
- name: "Kiá»ƒm tra SELinux status"
  ansible.builtin.command: getenforce
  register: selinux_status
  changed_when: false
  failed_when: false
  when: ansible_os_family == "RedHat"

- name: "Configure SELinux cho Wazuh Agent"
  ansible.posix.seboolean:
    name: "{{ item }}"
    state: yes
    persistent: yes
  loop:
    - use_nfs_home_dirs
    - virt_use_nfs
  become: yes
  when:
    - ansible_os_family == "RedHat"
    - selinux_status.stdout == "Enforcing"
  failed_when: false

# ==================== START WAZUH AGENT ====================
- name: "Enable vÃ  start Wazuh Agent"
  ansible.builtin.systemd:
    name: "{{ wazuh_agent_service_linux }}"
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes

# ==================== VERIFY INSTALLATION ====================
- name: "Chá» Wazuh Agent káº¿t ná»‘i vá»›i Manager"
  ansible.builtin.wait_for:
    timeout: 30
  delegate_to: localhost
  become: false

- name: "Kiá»ƒm tra tráº¡ng thÃ¡i Wazuh Agent"
  ansible.builtin.systemd:
    name: "{{ wazuh_agent_service_linux }}"
  register: wazuh_agent_status
  become: yes

- name: "Láº¥y thÃ´ng tin Agent ID"
  ansible.builtin.command: /var/ossec/bin/agent-control -l
  register: agent_info
  changed_when: false
  failed_when: false
  become: yes

- name: "Hiá»ƒn thá»‹ thÃ´ng tin Wazuh Agent"
  ansible.builtin.debug:
    msg: |
      
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘           âœ… WAZUH AGENT INSTALLATION COMPLETED                â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ğŸ–¥ï¸  Host:           {{ inventory_hostname }}
      ğŸ§ OS:             {{ ansible_distribution }} {{ ansible_distribution_version }}
      ğŸ“¦ Agent Name:     {{ wazuh_agent_name }}
      ğŸ‘¥ Agent Group:    {{ wazuh_agent_group }}
      
      ğŸ”— Connection:
      â”œâ”€ Manager IP:     {{ wazuh_manager_ip }}
      â”œâ”€ Manager Port:   {{ wazuh_manager_port }}
      â””â”€ Protocol:       {{ wazuh_manager_protocol | upper }}
      
      âœ… Service Status:  {{ 'Running' if wazuh_agent_status.status.ActiveState == 'active' else 'Stopped' }}
      
      ğŸ“‹ Verify Commands:
      â”œâ”€ Status:         sudo systemctl status {{ wazuh_agent_service_linux }}
      â”œâ”€ Logs:           sudo tail -f /var/ossec/logs/ossec.log
      â””â”€ Agent Info:     sudo /var/ossec/bin/agent-control -l
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
