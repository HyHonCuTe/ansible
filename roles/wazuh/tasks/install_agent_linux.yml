---
# File: roles/wazuh/tasks/install_agent_linux.yml
# MÃ´ táº£: CÃ i Ä‘áº·t Wazuh Agent trÃªn Linux (Ubuntu, Debian, CentOS, RHEL, Rocky, AlmaLinux)

# ==================== PREREQUISITES ====================
- name: "CÃ i Ä‘áº·t cÃ¡c gÃ³i phá»¥ thuá»™c (Debian/Ubuntu)"
  ansible.builtin.apt:
    name:
      - gnupg
      - apt-transport-https
      - curl
      - lsb-release
    state: present
    update_cache: yes
  become: yes
  when: ansible_os_family == "Debian"

- name: "CÃ i Ä‘áº·t cÃ¡c gÃ³i phá»¥ thuá»™c (RedHat/CentOS)"
  ansible.builtin.yum:
    name:
      - curl
      - gnupg
      - yum-utils
    state: present
  become: yes
  when: ansible_os_family == "RedHat"

# ==================== INSTALL WAZUH AGENT (Direct from URL) ====================
# Note: Installing specific version 4.7.5 to match manager version
- name: "Install Wazuh Agent from URL (Debian/Ubuntu)"
  ansible.builtin.apt:
    deb: "https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.7.5-1_amd64.deb"
    state: present
  become: yes
  when: ansible_os_family == "Debian"
  environment:
    WAZUH_MANAGER: "{{ wazuh_manager_ip }}"
    WAZUH_AGENT_GROUP: "{{ wazuh_agent_group }}"
    WAZUH_AGENT_NAME: "{{ wazuh_agent_name }}"
  register: apt_install_result
  until: apt_install_result is succeeded
  retries: 3
  delay: 10

- name: "Install Wazuh Agent from URL (RedHat/CentOS)"
  ansible.builtin.yum:
    name: "https://packages.wazuh.com/4.x/yum/wazuh-agent-4.7.5-1.x86_64.rpm"
    state: present
    disable_gpg_check: yes
  become: yes
  when: ansible_os_family == "RedHat"
  environment:
    WAZUH_MANAGER: "{{ wazuh_manager_ip }}"
    WAZUH_AGENT_GROUP: "{{ wazuh_agent_group }}"
    WAZUH_AGENT_NAME: "{{ wazuh_agent_name }}"
  register: yum_install_result
  until: yum_install_result is succeeded
  retries: 3
  delay: 10

# ==================== CONFIGURE WAZUH AGENT ====================
- name: "Deploy Wazuh Agent configuration"
  ansible.builtin.template:
    src: wazuh_agent_linux_ossec.conf.j2
    dest: "{{ wazuh_agent_config_path_linux }}"
    owner: root
    group: wazuh
    mode: '0640'
  become: yes
  notify: Restart wazuh-agent

# ==================== CONFIGURE SELINUX (RHEL/CENTOS) ====================
- name: "Kiá»ƒm tra SELinux status"
  ansible.builtin.command: getenforce
  register: selinux_status
  changed_when: false
  failed_when: false
  when: ansible_os_family == "RedHat"

- name: "Configure SELinux cho Wazuh Agent"
  ansible.posix.seboolean:
    name: "{{ item }}"
    state: yes
    persistent: yes
  loop:
    - use_nfs_home_dirs
    - virt_use_nfs
  become: yes
  when:
    - ansible_os_family == "RedHat"
    - selinux_status.stdout == "Enforcing"
  failed_when: false

# ==================== REMOVE DUPLICATE AGENT ON MANAGER (IF EXISTS) ====================
- name: "Kiá»ƒm tra agent Ä‘Ã£ tá»“n táº¡i trÃªn Manager"
  ansible.builtin.shell: |
    /var/ossec/bin/agent_control -l 2>/dev/null | grep -i "{{ inventory_hostname }}" | awk -F',' '{print $1}' | awk '{print $2}' | head -1
  delegate_to: "{{ groups['wazuh_server'][0] }}"
  connection: local
  register: existing_agent_id
  become: yes
  failed_when: false
  changed_when: false
  ignore_errors: yes
  when: wazuh_remove_duplicate_agent | default(true)

- name: "XÃ³a agent duplicate trÃªn Manager (náº¿u tá»“n táº¡i)"
  ansible.builtin.shell: |
    echo "y" | /var/ossec/bin/manage_agents -r {{ existing_agent_id.stdout }}
  delegate_to: "{{ groups['wazuh_server'][0] }}"
  connection: local
  become: yes
  when:
    - wazuh_remove_duplicate_agent | default(true)
    - existing_agent_id.stdout is defined
    - existing_agent_id.stdout | length > 0
  failed_when: false
  changed_when: true

- name: "XÃ³a client.keys cÅ© trÃªn agent (náº¿u cÃ³)"
  ansible.builtin.file:
    path: /var/ossec/etc/client.keys
    state: absent
  become: yes
  when: wazuh_remove_duplicate_agent | default(true)

# ==================== REGISTER AGENT WITH MANAGER ====================
- name: "Register agent using agent-auth"
  ansible.builtin.shell: |
    /var/ossec/bin/agent-auth -m {{ wazuh_manager_ip }} -A {{ inventory_hostname }} -G {{ wazuh_agent_group }}
  become: yes
  register: agent_auth_result
  failed_when: false
  changed_when: "'Valid key received' in agent_auth_result.stdout or 'Valid key created' in agent_auth_result.stdout"
  retries: 3
  delay: 5
  until: agent_auth_result.rc == 0

- name: "Debug agent-auth output"
  ansible.builtin.debug:
    var: agent_auth_result
  when: agent_auth_result.rc != 0

# ==================== START WAZUH AGENT ====================
- name: "Enable vÃ  start Wazuh Agent"
  ansible.builtin.systemd:
    name: "{{ wazuh_agent_service_linux }}"
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes

# ==================== VERIFY INSTALLATION ====================
- name: "Chá» Wazuh Agent káº¿t ná»‘i vá»›i Manager"
  ansible.builtin.wait_for:
    timeout: 30
  delegate_to: localhost
  connection: local
  become: false

- name: "Kiá»ƒm tra tráº¡ng thÃ¡i Wazuh Agent"
  ansible.builtin.systemd:
    name: "{{ wazuh_agent_service_linux }}"
  register: wazuh_agent_status
  become: yes

- name: "Láº¥y thÃ´ng tin Agent ID"
  ansible.builtin.command: /var/ossec/bin/agent-control -l
  register: agent_info
  changed_when: false
  failed_when: false
  become: yes

- name: "Hiá»ƒn thá»‹ thÃ´ng tin Wazuh Agent"
  ansible.builtin.debug:
    msg: |
      
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘           âœ… WAZUH AGENT INSTALLATION COMPLETED                â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ğŸ–¥ï¸  Host:           {{ inventory_hostname }}
      ğŸ§ OS:             {{ ansible_distribution }} {{ ansible_distribution_version }}
      ğŸ“¦ Agent Name:     {{ wazuh_agent_name }}
      ğŸ‘¥ Agent Group:    {{ wazuh_agent_group }}
      
      ğŸ”— Connection:
      â”œâ”€ Manager IP:     {{ wazuh_manager_ip }}
      â”œâ”€ Manager Port:   {{ wazuh_manager_port }}
      â””â”€ Protocol:       {{ wazuh_manager_protocol | upper }}
      
      âœ… Service Status:  {{ 'Running' if wazuh_agent_status.status.ActiveState == 'active' else 'Stopped' }}
      
      ğŸ“‹ Verify Commands:
      â”œâ”€ Status:         sudo systemctl status {{ wazuh_agent_service_linux }}
      â”œâ”€ Logs:           sudo tail -f /var/ossec/logs/ossec.log
      â””â”€ Agent Info:     sudo /var/ossec/bin/agent-control -l
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
