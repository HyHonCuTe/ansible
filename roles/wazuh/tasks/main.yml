---
# File: roles/wazuh/tasks/main.yml
# MÃ´ táº£: Entry point cho Wazuh Role, Ä‘iá»u hÆ°á»›ng theo mode

- name: "Hiá»ƒn thá»‹ thÃ´ng tin cáº¥u hÃ¬nh Wazuh"
  ansible.builtin.debug:
    msg: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘              WAZUH DEPLOYMENT CONFIGURATION                    â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ğŸ–¥ï¸  Host:           {{ inventory_hostname }}
      ğŸ§ OS:             {{ ansible_distribution }} {{ ansible_distribution_version }}
      ğŸ”§ Mode:           {{ wazuh_mode | upper }}
      ğŸ“¦ Wazuh Version:  {{ wazuh_version }}
      {% if wazuh_mode == "agent" %}
      ğŸ¯ Manager IP:     {{ wazuh_manager_ip }}
      ğŸ‘¥ Agent Group:    {{ wazuh_agent_group }}
      {% endif %}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: "Kiá»ƒm tra wazuh_mode há»£p lá»‡"
  ansible.builtin.fail:
    msg: |
      âŒ Lá»—i: wazuh_mode pháº£i lÃ  "server" hoáº·c "agent"
      GiÃ¡ trá»‹ hiá»‡n táº¡i: {{ wazuh_mode }}
  when: wazuh_mode not in ["server", "agent"]

# ==================== WAZUH SERVER DEPLOYMENT ====================
- name: "Include install_server.yml náº¿u mode = server"
  ansible.builtin.include_tasks: install_server.yml
  when: 
    - wazuh_mode == "server"
    - ansible_os_family != "Windows"
    - ansible_os_family != "Darwin"

# ==================== WAZUH AGENT DEPLOYMENT - LINUX ====================
- name: "Include install_agent_linux.yml náº¿u mode = agent vÃ  OS lÃ  Linux"
  ansible.builtin.include_tasks: install_agent_linux.yml
  when:
    - wazuh_mode == "agent"
    - ansible_os_family in ["Debian", "RedHat", "Suse"]

# ==================== WAZUH AGENT DEPLOYMENT - WINDOWS ====================
- name: "Include install_agent_windows.yml náº¿u mode = agent vÃ  OS lÃ  Windows"
  ansible.builtin.include_tasks: install_agent_windows.yml
  when:
    - wazuh_mode == "agent"
    - ansible_os_family == "Windows"

# ==================== WAZUH AGENT DEPLOYMENT - MACOS ====================
- name: "Include install_agent_macos.yml náº¿u mode = agent vÃ  OS lÃ  macOS"
  ansible.builtin.include_tasks: install_agent_macos.yml
  when:
    - wazuh_mode == "agent"
    - ansible_os_family == "Darwin"

# ==================== SUMMARY ====================
- name: "Hiá»ƒn thá»‹ thÃ´ng bÃ¡o hoÃ n táº¥t"
  ansible.builtin.debug:
    msg: |
      
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘              âœ… WAZUH DEPLOYMENT COMPLETED                     â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ğŸ–¥ï¸  Host:       {{ inventory_hostname }}
      ğŸ”§ Mode:       {{ wazuh_mode | upper }}
      âœ… Status:     Deployment successful
      
      {% if wazuh_mode == "server" %}
      ğŸŒ Access URLs:
      â”œâ”€ Dashboard:  https://{{ ansible_default_ipv4.address | default(wazuh_manager_ip) }}:443
      â”œâ”€ API:        https://{{ ansible_default_ipv4.address | default(wazuh_manager_ip) }}:55000
      â””â”€ Indexer:    https://{{ ansible_default_ipv4.address | default(wazuh_manager_ip) }}:9200
      
      ğŸ“‹ Default Credentials:
      â”œâ”€ User:       {{ wazuh_api_user }}
      â””â”€ Password:   {{ wazuh_api_password }}
      {% elif wazuh_mode == "agent" %}
      ğŸ”— Connected to Manager: {{ wazuh_manager_ip }}:{{ wazuh_manager_port }}
      
      ğŸ“ Verify agent status:
      {% if ansible_os_family == "Windows" %}
      Get-Service WazuhSvc
      {% elif ansible_os_family == "Darwin" %}
      sudo /Library/Ossec/bin/agent-control -l
      {% else %}
      sudo systemctl status wazuh-agent
      sudo /var/ossec/bin/agent-control -l
      {% endif %}
      {% endif %}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
