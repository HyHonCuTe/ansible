---
# Alert Rules for Prometheus System Monitoring
# Configured to trigger at 80% threshold

apiVersion: 1

groups:
  - orgId: 1
    name: System Resource Alerts - 80% Threshold
    folder: Monitoring
    interval: 1m
    rules:
      - uid: cpu_usage_high
        title: High CPU Usage (>80%)
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: '100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)'
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 80
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
          - refId: C
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: C
              type: reduce
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: 'CPU usage is above 80% on {{ $labels.instance }}'
          summary: 'High CPU usage detected'
        labels:
          severity: warning

      - uid: memory_usage_high
        title: High Memory Usage (>80%)
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: '(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100'
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 80
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
          - refId: C
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: C
              type: reduce
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: 'Memory usage is above 80% on {{ $labels.instance }}'
          summary: 'High memory usage detected'
        labels:
          severity: warning

      - uid: disk_usage_high
        title: High Disk Usage (>80%)
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: '(1 - (node_filesystem_avail_bytes{mountpoint="/",fstype!="rootfs"} / node_filesystem_size_bytes{mountpoint="/",fstype!="rootfs"})) * 100'
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 80
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
          - refId: C
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: C
              type: reduce
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: 'Disk usage is above 80% on {{ $labels.instance }} mountpoint {{ $labels.mountpoint }}'
          summary: 'High disk usage detected'
        labels:
          severity: warning

      - uid: node_down
        title: Node Down
        condition: C
        data:
          - refId: A
            queryType: ''
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'up{job="node_exporter"}'
              refId: A
          - refId: B
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
              type: threshold
          - refId: C
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              refId: C
              type: reduce
        noDataState: Alerting
        execErrState: Error
        for: 2m
        annotations:
          description: 'Node {{ $labels.instance }} is down or unreachable'
          summary: 'Node is down'
        labels:
          severity: critical
